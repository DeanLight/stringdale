<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.9.13">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Basic Diagram Examples – StringDALE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ac077c1e730dfeb5e42400639d17284e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-000f0825b9c55ed21d14970d810c14a9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Basic Diagram Examples – StringDALE">
<meta property="og:description" content="String Diagram Agent Language Express (StringDALE) is a language for building LLM agents using string diagrams.">
<meta property="og:image" content="https://DeanLight.github.io/StringDALE/015_diagram_unit_tests_files/figure-html/cell-11-output-1.svg">
<meta property="og:site_name" content="StringDALE">
<meta name="twitter:title" content="Basic Diagram Examples – StringDALE">
<meta name="twitter:description" content="String Diagram Agent Language Express (StringDALE) is a language for building LLM agents using string diagrams.">
<meta name="twitter:image" content="https://DeanLight.github.io/StringDALE/015_diagram_unit_tests_files/figure-html/cell-11-output-1.svg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">StringDALE</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Getting Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./docs/tutorials/getting_started.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./docs/examples/001_rag.html"> 
<span class="menu-text">Examples</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./docs/reference/diagrams.html"> 
<span class="menu-text">Reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/DeanLight/stringdale"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Basic Diagram Examples</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello world</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/port_mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Port Mapping</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/decision_diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decision Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/nested_diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nested Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/compound_diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Compound Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/customizing_state.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Customizing State</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/stateful_nodes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stateful Nodes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/batching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Batching</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/keeping_diagrams_dry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Keeping Diagrams DRY</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Examples</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/examples/001_rag.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RAG</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/examples/002_react.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">React</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/examples/003_interactive_qa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactive QA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/examples/rag_on_summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RAG on summary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/examples/interactive_qa_db.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactive QA with DB</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/examples/monitor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Monitor Pattern</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/examples/router.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Routing Pattern</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Reference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/reference/diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/reference/chat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/reference/dbs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DBs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/reference/tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tools</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/reference/eval.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Eval</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link active" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#intro" id="toc-intro" class="nav-link" data-scroll-target="#intro">Intro</a></li>
  <li><a href="#defining-ports-of-an-edge" id="toc-defining-ports-of-an-edge" class="nav-link" data-scroll-target="#defining-ports-of-an-edge">Defining ports of an edge</a></li>
  <li><a href="#edge-types" id="toc-edge-types" class="nav-link" data-scroll-target="#edge-types">Edge types</a></li>
  <li><a href="#missing-start-end" id="toc-missing-start-end" class="nav-link" data-scroll-target="#missing-start-end">Missing start / End</a></li>
  <li><a href="#edge-types-1" id="toc-edge-types-1" class="nav-link" data-scroll-target="#edge-types-1">Edge Types</a>
  <ul class="collapse">
  <li><a href="#read-state" id="toc-read-state" class="nav-link" data-scroll-target="#read-state">Read State</a></li>
  <li><a href="#parallel-with-async-functions" id="toc-parallel-with-async-functions" class="nav-link" data-scroll-target="#parallel-with-async-functions">Parallel with async functions</a></li>
  </ul></li>
  <li><a href="#parallel-with-state" id="toc-parallel-with-state" class="nav-link" data-scroll-target="#parallel-with-state">Parallel with State</a></li>
  <li><a href="#nested-parallel-with-state" id="toc-nested-parallel-with-state" class="nav-link" data-scroll-target="#nested-parallel-with-state">Nested Parallel with State</a></li>
  <li><a href="#state-inside-scope" id="toc-state-inside-scope" class="nav-link" data-scroll-target="#state-inside-scope">State inside scope</a></li>
  <li><a href="#multiple-edges-from-same-node" id="toc-multiple-edges-from-same-node" class="nav-link" data-scroll-target="#multiple-edges-from-same-node">Multiple edges from same node</a></li>
  <li><a href="#unnamed-ports-for-discarding-inputs" id="toc-unnamed-ports-for-discarding-inputs" class="nav-link" data-scroll-target="#unnamed-ports-for-discarding-inputs">Unnamed ports for discarding inputs</a></li>
  <li><a href="#llm-dummy-functions" id="toc-llm-dummy-functions" class="nav-link" data-scroll-target="#llm-dummy-functions">LLM dummy functions</a></li>
  <li><a href="#self-loop" id="toc-self-loop" class="nav-link" data-scroll-target="#self-loop">self loop</a></li>
  <li><a href="#choosing-tools" id="toc-choosing-tools" class="nav-link" data-scroll-target="#choosing-tools">Choosing tools</a></li>
  <li><a href="#parallel-flows" id="toc-parallel-flows" class="nav-link" data-scroll-target="#parallel-flows">parallel flows</a></li>
  <li><a href="#nested" id="toc-nested" class="nav-link" data-scroll-target="#nested">Nested</a></li>
  <li><a href="#compound" id="toc-compound" class="nav-link" data-scroll-target="#compound">Compound</a></li>
  <li><a href="#overide-defines" id="toc-overide-defines" class="nav-link" data-scroll-target="#overide-defines">Overide defines</a></li>
  <li><a href="#break-with-state" id="toc-break-with-state" class="nav-link" data-scroll-target="#break-with-state">Break with state</a></li>
  <li><a href="#parallel-with-break" id="toc-parallel-with-break" class="nav-link" data-scroll-target="#parallel-with-break">Parallel with break</a></li>
  <li><a href="#nested-breaks" id="toc-nested-breaks" class="nav-link" data-scroll-target="#nested-breaks">Nested breaks</a></li>
  <li><a href="#cant-break-inside-parallel" id="toc-cant-break-inside-parallel" class="nav-link" data-scroll-target="#cant-break-inside-parallel">Cant break inside parallel</a></li>
  <li><a href="#far-ancestor-writing-to-state" id="toc-far-ancestor-writing-to-state" class="nav-link" data-scroll-target="#far-ancestor-writing-to-state">Far ancestor writing to state</a></li>
  <li><a href="#initializing-state" id="toc-initializing-state" class="nav-link" data-scroll-target="#initializing-state">Initializing state</a></li>
  <li><a href="#nested-state-basemodels" id="toc-nested-state-basemodels" class="nav-link" data-scroll-target="#nested-state-basemodels">Nested state basemodels</a></li>
  <li><a href="#init-with-state-clash" id="toc-init-with-state-clash" class="nav-link" data-scroll-target="#init-with-state-clash">Init with state clash</a>
  <ul class="collapse">
  <li><a href="#missing-input-state" id="toc-missing-input-state" class="nav-link" data-scroll-target="#missing-input-state">Missing input state</a></li>
  </ul></li>
  <li><a href="#stateful-nodes-and-serialization" id="toc-stateful-nodes-and-serialization" class="nav-link" data-scroll-target="#stateful-nodes-and-serialization">Stateful nodes and Serialization</a></li>
  <li><a href="#conflicting-ports" id="toc-conflicting-ports" class="nav-link" data-scroll-target="#conflicting-ports">Conflicting ports</a></li>
  <li><a href="#exception-during-condition" id="toc-exception-during-condition" class="nav-link" data-scroll-target="#exception-during-condition">Exception during condition</a>
  <ul class="collapse">
  <li><a href="#defining-conditional-edges-after-node-definition" id="toc-defining-conditional-edges-after-node-definition" class="nav-link" data-scroll-target="#defining-conditional-edges-after-node-definition">defining conditional edges after node definition</a></li>
  </ul></li>
  <li><a href="#batch-processing" id="toc-batch-processing" class="nav-link" data-scroll-target="#batch-processing">Batch processing</a>
  <ul class="collapse">
  <li><a href="#batch-processing-with-async-functions" id="toc-batch-processing-with-async-functions" class="nav-link" data-scroll-target="#batch-processing-with-async-functions">Batch processing with async functions</a></li>
  <li><a href="#cartesian-product-of-input-streams" id="toc-cartesian-product-of-input-streams" class="nav-link" data-scroll-target="#cartesian-product-of-input-streams">Cartesian product of input streams</a></li>
  </ul></li>
  <li><a href="#using-for_each-with-both-stream-and-non-stream-inputs" id="toc-using-for_each-with-both-stream-and-non-stream-inputs" class="nav-link" data-scroll-target="#using-for_each-with-both-stream-and-non-stream-inputs">Using for_each with both stream and non stream inputs</a></li>
  <li><a href="#nested-diagrams-in-foreach" id="toc-nested-diagrams-in-foreach" class="nav-link" data-scroll-target="#nested-diagrams-in-foreach">Nested diagrams in foreach</a></li>
  <li><a href="#nested-decision-diagrams-under-foreach" id="toc-nested-decision-diagrams-under-foreach" class="nav-link" data-scroll-target="#nested-decision-diagrams-under-foreach">Nested decision diagrams under foreach</a></li>
  <li><a href="#text-splitting" id="toc-text-splitting" class="nav-link" data-scroll-target="#text-splitting">Text splitting</a></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/DeanLight/StringDALE/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Basic Diagram Examples</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="imports" class="level2">
<h2 class="anchored" data-anchor-id="imports">Imports</h2>
<div id="cell-3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale <span class="im">import</span> (</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    Define,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    Scope,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    V,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    E,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    Condition,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    draw_nx</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale.core <span class="im">import</span>  checkLogs</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="intro" class="level2">
<h2 class="anchored" data-anchor-id="intro">Intro</h2>
<p>stringdale diagrams are written as a graph of nodes and edges.</p>
<p>There are 3 reserved node names: * State: a node that is used to store and access state between node executions * Start: the start of the diagram * End: the end of the diagram</p>
<p>The edges can be of three types: * state: an edge from the State node to another node, used for either setting or getting part of the state * conditional: edges with a possible condition which are used for deciding which node to run next * parallel: edges that are used to run multiple nodes in parallel</p>
<p>Note that each node can have multiple edges coming in and out of it. But all non state incoming edges must either be all conditional or all parallel. The same goes for outgoing edges.</p>
<p>Edges can not only define the flow of the diagram, but also which part of the output of a node is passed to the input of another node.</p>
<p>Lets look at how to define and runa basic diagram.</p>
</section>
<section id="defining-ports-of-an-edge" class="level2">
<h2 class="anchored" data-anchor-id="defining-ports-of-an-edge">Defining ports of an edge</h2>
<div id="cell-7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#TODO make diagram with ** port for kwarg spread</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'edge_signature'</span>) <span class="im">as</span> D:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we define the nodes with V</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start and End are reserved node names which are automatically added to the diagram</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if no function is provided, the node simply passes all its inputs as a dictionary to the next node</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we define the edges with E</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the edge signature is Start.output_port-&gt;End.input_port</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this means that the output of the Start node is passed to the input of the End node</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;End(input_port = output_port)'</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for our convenience, exiting the Define block automatically draws the diagram</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># outside of the Define block,</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># we can now run the diagram</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># to make sure we get a fresh copy of the diagram in cases where we want have multiple instances of the same diagram</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># we can use the GetDiagram function</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams'):</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'output_port'</span>:<span class="dv">1</span>,<span class="st">'other_port'</span>:<span class="dv">2</span>}):</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># every node that is run will return a trace object</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this trace object contains the input and output of the node as well as some other useful information</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can use this trace to both debug the diagram </span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and also to perform other side effects such:</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * as logging</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * writing responses back to the user</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co"># we access the output of the diagram via the output property</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># note that the output_port of the Start node is passed to the input_port of the End node</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># the other port is discarded</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>d.output</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'input_port'</span>:<span class="dv">1</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  output_port: 1
  other_port: 2
output:
  output_port: 1
  other_port: 2
---
name: End
input:
  input_port: 1
output:
  input_port: 1
---</code></pre>
</div>
</div>
</section>
<section id="edge-types" class="level2">
<h2 class="anchored" data-anchor-id="edge-types">Edge types</h2>
<div id="cell-9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># EXPLAIN start and end are by default</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='__main__'):</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'multiedge'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'plus'</span>,plus,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Start(x=a,y=b)'</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-10" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>log_file <span class="op">=</span> <span class="st">'log.txt'</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'a'</span>:<span class="dv">1</span>,<span class="st">'b'</span>:<span class="dv">2</span>}):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    trace.pprint(<span class="bu">file</span><span class="op">=</span>log_file)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">3</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-11" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> cat log.txt</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>os.unlink(log_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  a: 1
  b: 2
output:
  a: 1
  b: 2
---
name: plus
input:
  x: 1
  y: 2
output: 3
---
name: End
input:
  0: 3
output: 3
---</code></pre>
</div>
</div>
<div id="cell-12" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-13" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus2(x):</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">2</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mod2(x):</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">%</span><span class="dv">2</span><span class="op">==</span><span class="dv">0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-14" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'naive_flow'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> NaiveFlow:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'plus1'</span>,plus1,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End(x=.)'</span>])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'plus2'</span>,plus2,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End(y=.)'</span>])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> NaiveFlow()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-15" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>trace_steps <span class="op">=</span> []</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        trace.pprint()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        trace_steps.append(trace.node_name[<span class="dv">0</span>])</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> (trace_steps <span class="op">==</span>[<span class="st">'Start'</span>,<span class="st">'plus1'</span>,<span class="st">'plus2'</span>,<span class="st">'End'</span>] <span class="kw">or</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        trace_steps <span class="op">==</span>[<span class="st">'Start'</span>,<span class="st">'plus2'</span>,<span class="st">'plus1'</span>,<span class="st">'End'</span>]),trace_steps</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'x'</span>: <span class="dv">2</span>, <span class="st">'y'</span>: <span class="dv">3</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: plus1
input:
  0: 1
output: 2
---
name: plus2
input:
  0: 1
output: 3
---
name: End
input:
  x: 2
  y: 3
output:
  x: 2
  y: 3
---</code></pre>
</div>
</div>
<div id="cell-16" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>,match<span class="op">=</span><span class="st">'cannot have multiple output edges with no condition'</span>):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Define(<span class="st">'naive_flow'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> NaiveFlow:</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'plus1'</span>,plus1,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End(x=.)'</span>])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'plus2'</span>,plus2,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End(y=.)'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-11-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="missing-start-end" class="level2">
<h2 class="anchored" data-anchor-id="missing-start-end">Missing start / End</h2>
<div id="cell-18" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>,match<span class="op">=</span><span class="st">'unreachable from the start node'</span>):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Define(<span class="st">'edge_signature'</span>) <span class="im">as</span> D:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we define the nodes with V</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Start and End are reserved node names which are automatically added to the diagram</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if no function is provided, the node simply passes all its inputs as a dictionary to the next node</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'start'</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'End'</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we define the edges with E</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the edge signature is Start.output_port-&gt;End.input_port</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this means that the output of the Start node is passed to the input of the End node</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Start-&gt;End(input_port = output_port)'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-12-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="edge-types-1" class="level2">
<h2 class="anchored" data-anchor-id="edge-types-1">Edge Types</h2>
<div id="cell-20" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.validate'):</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'edge_types'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> EdgeTypes:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Conditional_node'</span>,plus1)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;Conditional_node'</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Option1'</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Default_option'</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># by default, all edges we define are conditional,</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can specify a condition for an edge by passing a function to the cond argument</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Conditional_node-&gt;Option1'</span>,cond<span class="op">=</span>mod2)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not passing a condition means that this edge is the default edge</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># each node that has outgoing conditional edges must have at least one default edge</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Conditional_node-&gt;Default_option'</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can also define a parallel edge by passing scope='parallel' to the E function</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node1'</span>,plus1)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node2'</span>,plus2)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Option1-&gt;Parallel_node1'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Option1-&gt;Parallel_node2'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node1-&gt;Parallel_end(x=.)'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node2-&gt;Parallel_end(y=.)'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_end-&gt;End(**)'</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Default_option-&gt;End'</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can also read and write to state by using the State node in edge definitions.</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the port of the State node is the key of the state we would like to read from or write to</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the port of the node we are connecting to is the value we would like to write to the state</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if we want to read from the state, we can use the State.port notation</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;state/start'</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'state/start-&gt;End(start_state=.)'</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> EdgeTypes()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-21" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>d.draw(factored<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-14-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-14-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-22" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>draw_nx(d.funcs[<span class="st">'anon_from_Option1_to_Parallel_end'</span>].graph)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-15-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-23" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trace.pprint()</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'x'</span>: <span class="dv">3</span>, <span class="st">'y'</span>: <span class="dv">4</span>, <span class="st">'start_state'</span>: <span class="dv">1</span>} , d.output</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-24" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams'):</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="dv">0</span>:<span class="dv">1</span>,<span class="st">'start_state'</span>:<span class="dv">0</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 0
output: 0
---
name: Conditional_node
input:
  0: 0
output: 1
---
name: Default_option
input:
  0: 1
output: 1
---
name: End
input:
  0: 1
  start_state: 0
output:
  0: 1
  start_state: 0
---</code></pre>
</div>
</div>
<section id="custom-state" class="level4">
<h4 class="anchored" data-anchor-id="custom-state">Custom state</h4>
<div id="cell-26" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale.core <span class="im">import</span> NamedLambda</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>plus1 <span class="op">=</span> NamedLambda(<span class="st">'plus1'</span>,<span class="kw">lambda</span> x: x<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel,ConfigDict,computed_field</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># a custom state is any basemodel</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomState(BaseModel):</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can allow arbitrary attributes by setting extra='allow'</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this is useful for defining on the fly state keys with normal behavior</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    model_config <span class="op">=</span> ConfigDict(extra<span class="op">=</span><span class="st">'allow'</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    history:<span class="bu">list</span>[<span class="bu">int</span>] <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(<span class="va">self</span>,value):</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history.append(value)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'test1'</span>,state<span class="op">=</span>CustomState()) <span class="im">as</span> D:</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,plus1)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can define a custom state class by passing it to the State function</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># within the Define scope</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add'</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add-&gt;End'</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add-&gt;State/save'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-27" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">2</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.state.model_dump() <span class="op">==</span> {<span class="st">'history'</span>: [<span class="dv">2</span>]},d.state</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: add
input:
  0: 1
output: 2
---
name: End
input:
  0: 2
output: 2
---</code></pre>
</div>
</div>
<div id="cell-28" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'test1_exp'</span>,state<span class="op">=</span>CustomState()) <span class="im">as</span> D:</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,plus1)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can customize the state behaviour of a given state key by using the State function</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set_append=True means that the state value will be appended to the list of values for the given key</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can also add custom getters and setters to a state key for more complex state behaviour</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># getter is a function of the form (value)-&gt;(processed_value)</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># setter is a function of the form (old_value,new_value)-&gt;(processed_value)</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add'</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add-&gt;End'</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add-&gt;State/save'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-29" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">2</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.state.model_dump() <span class="op">==</span> {<span class="st">'history'</span>: [<span class="dv">2</span>]},d.state</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: add
input:
  0: 1
output: 2
---
name: End
input:
  0: 2
output: 2
---</code></pre>
</div>
</div>
</section>
<section id="read-state" class="level3">
<h3 class="anchored" data-anchor-id="read-state">Read State</h3>
<div id="cell-31" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'test_state_read'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> D:</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,plus1,func_name<span class="op">=</span><span class="st">'plusone'</span>,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End(data=.)'</span>])</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'state/outside_state-&gt;End(state_data=.)'</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>D.draw()</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>d.state.outside_state <span class="op">=</span><span class="dv">10</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> checkLogs(name<span class="op">=</span><span class="st">'stringdale.diagrstams.flow'</span>):</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        trace.pprint()</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'data'</span>: <span class="dv">2</span>, <span class="st">'state_data'</span>: <span class="dv">10</span>}, d.output</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-22-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: add
input:
  0: 1
output: 2
---
name: End
input:
  data: 2
  state_data: 10
output:
  data: 2
  state_data: 10
---</code></pre>
</div>
</div>
<section id="parallel-graph" class="level4">
<h4 class="anchored" data-anchor-id="parallel-graph">Parallel graph</h4>
<div id="cell-33" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x,<span class="op">**</span>kwargs):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='__main__'):</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'test2'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus1)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add2'</span>,plus1)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,outputs<span class="op">=</span>[<span class="st">'add1'</span>,<span class="st">'add2'</span>])</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'prep_end'</span>,inputs<span class="op">=</span>[<span class="st">'add1(x=.)'</span>,<span class="st">'add2(y=.)'</span>])</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'prep_end-&gt;End'</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-23-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-34" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'x'</span>: <span class="dv">2</span>, <span class="st">'y'</span>: <span class="dv">2</span>}</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: add1
input:
  0: 1
output: 2
---
name: add2
input:
  0: 1
output: 2
---
name: prep_end
input:
  x: 2
  y: 2
output:
  x: 2
  y: 2
---
name: End
input:
  0:
    x: 2
    y: 2
output:
  x: 2
  y: 2
---</code></pre>
</div>
</div>
</section>
</section>
<section id="parallel-with-async-functions" class="level3">
<h3 class="anchored" data-anchor-id="parallel-with-async-functions">Parallel with async functions</h3>
<div id="cell-36" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> plus1async(x,<span class="op">**</span>kwargs):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="fl">0.1</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='__main__'):</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'test'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus1async)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add2'</span>,plus1async)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,outputs<span class="op">=</span>[<span class="st">'add1'</span>,<span class="st">'add2'</span>])</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'prepend1'</span>,inputs<span class="op">=</span>[<span class="st">'add1(x)'</span>,<span class="st">'add2(y)'</span>])</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'prepend1-&gt;End'</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-25-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-37" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'x'</span>: <span class="dv">2</span>, <span class="st">'y'</span>: <span class="dv">2</span>}</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: add1
input:
  0: 1
output: 2
---
name: add2
input:
  0: 1
output: 2
---
name: prepend1
input:
  x: 2
  y: 2
output:
  x: 2
  y: 2
---
name: End
input:
  0:
    x: 2
    y: 2
output:
  x: 2
  y: 2
---</code></pre>
</div>
</div>
</section>
</section>
<section id="parallel-with-state" class="level2">
<h2 class="anchored" data-anchor-id="parallel-with-state">Parallel with State</h2>
<div id="cell-39" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional,Annotated,Any</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-40" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomState(BaseModel):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#model_config = ConfigDict(extra='allow')</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># note that without the extra='allow' we would not be able to set any other state attributes</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    history:Annotated[<span class="bu">list</span>[Any],<span class="bu">list</span>.append] <span class="op">=</span> []</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-41" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Inner'</span>,state<span class="op">=</span>CustomState()) <span class="im">as</span> Inner:</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;State/history'</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'DoSomething'</span>, </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start'</span>],</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'State/history'</span>]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,inputs<span class="op">=</span>[<span class="st">'DoSomething'</span>])</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>Inner.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-29-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-42" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> Inner()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.state.model_dump() <span class="op">==</span> {<span class="st">'history'</span>: [<span class="dv">1</span>,<span class="dv">1</span>]}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: DoSomething
input:
  0: 1
output: 1
---
name: End
input:
  0: 1
output: 1
---</code></pre>
</div>
</div>
<div id="cell-43" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> Inner()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> messages:</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span>m):</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.state.model_dump() <span class="op">==</span> {<span class="st">'history'</span>: [<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>]}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="nested-parallel-with-state" class="level2">
<h2 class="anchored" data-anchor-id="nested-parallel-with-state">Nested Parallel with State</h2>
<div id="cell-45" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TimerState(BaseModel):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    t:<span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tick(<span class="va">self</span>,value):</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.t <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_timeout(<span class="va">self</span>):</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.t <span class="op">&lt;=</span> <span class="dv">0</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>is_truthy <span class="op">=</span> <span class="kw">lambda</span> x: <span class="bu">bool</span>(x)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-46" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Outer'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>,state<span class="op">=</span>TimerState()) <span class="im">as</span> Outer:</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Inner'</span>,Inner,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start'</span>],</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'State/tick'</span>,<span class="st">'should_end'</span>]</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'should_end'</span>,inputs<span class="op">=</span>[<span class="st">'State/is_timeout(timeout)'</span>],</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'End(0=0)'</span>,Condition(is_truthy,<span class="st">'(0=timeout)'</span>)),</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Inner(0=0)'</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>Outer.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-33-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-47" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> Outer()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>d.output</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d[<span class="st">'Inner'</span>].state.model_dump() <span class="op">==</span> {<span class="st">'history'</span>: [<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>]}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="state-inside-scope" class="level2">
<h2 class="anchored" data-anchor-id="state-inside-scope">State inside scope</h2>
<div id="cell-49" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'SimpleStateExample'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> SimpleFlow:</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize state</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'State/user_input'</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Decision_start'</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;State/user_input'</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node outside of decision scope accessing state</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparation node for decision scope</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Decision_start'</span>)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decision scope with node accessing state</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'decision'</span>):</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'handle_state'</span>,</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span>[<span class="st">'Decision_start(data=.)'</span>,</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'State/user_input(input=.)'</span>],</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>            outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>SimpleFlow.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-35-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-50" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SimpleFlow.draw(factored=True)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-51" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> SimpleFlow()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> {<span class="st">'data'</span>:<span class="dv">1</span>,<span class="st">'input'</span>:<span class="dv">1</span>} <span class="op">==</span> d.output</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-52" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'SimpleStateExample'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> SimpleFlow:</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize state</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;State/user_input'</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node outside of decision scope accessing state</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'process_input'</span>, </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'State/user_input'</span>,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Start'</span>]</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparation node for decision scope</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Decision_start'</span>,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'process_input'</span>]</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decision scope with node accessing state</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'decision'</span>):</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'handle_state'</span>,</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span>[<span class="st">'Decision_start'</span>,</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'State/user_input(input=.)'</span>],</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>            outputs<span class="op">=</span>[<span class="st">'Decision_End'</span>]</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Decision_End-&gt;End'</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>SimpleFlow.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-38-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-53" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> SimpleFlow()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="dv">0</span>: <span class="dv">1</span>, <span class="st">'input'</span>: <span class="dv">1</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 1
output: 1
---
name: process_input
input:
  0: 1
output: 1
---
name: Decision_start
input:
  0: 1
output: 1
---
name: handle_state
input:
  0: 1
  input: 1
output:
  0: 1
  input: 1
---
name: Decision_End
input:
  0:
    0: 1
    input: 1
output:
  0: 1
  input: 1
---
name: End
input:
  0:
    0: 1
    input: 1
output:
  0: 1
  input: 1
---</code></pre>
</div>
</div>
</section>
<section id="multiple-edges-from-same-node" class="level2">
<h2 class="anchored" data-anchor-id="multiple-edges-from-same-node">Multiple edges from same node</h2>
<div id="cell-55" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># EXPLAIN start and end are by default</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='__main__'):</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'multiedge'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'plus'</span>,plus,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start(x=a,y=b)'</span>],</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>D.draw()</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'a'</span>:<span class="dv">1</span>,<span class="st">'b'</span>:<span class="dv">2</span>}):</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">3</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-40-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="unnamed-ports-for-discarding-inputs" class="level2">
<h2 class="anchored" data-anchor-id="unnamed-ports-for-discarding-inputs">Unnamed ports for discarding inputs</h2>
<div id="cell-57" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># EXPLAIN start and end are by default</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'unnamed_ports'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;state/start'</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'plus'</span>,plus1,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Start(_)'</span>,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'state/start(x=.)'</span>],</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>D.draw()</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>dot <span class="op">=</span> d.draw(return_dot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>dot.source</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-41-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'digraph multiedge {\n\tlabel=multiedge labelloc=t rankdir=LR\n\tnode_0 [label="plus[ plus ]" color="#9370DB" fillcolor="#ECECFF" shape=box style="solid,filled"]\n\tnode_1 [label=Start color="#9370DB" fillcolor="#ECECFF" shape=box style="solid,filled"]\n\tnode_2 [label=End color="#9370DB" fillcolor="#ECECFF" shape=box style="solid,filled"]\n\tnode_0 -&gt; node_2 [color=black style=solid]\n\tnode_1 -&gt; node_0 [label="a -&gt; x, b -&gt; y" color=black style=solid]\n}\n'</code></pre>
</div>
</div>
<div id="cell-58" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):    </span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="llm-dummy-functions" class="level2">
<h2 class="anchored" data-anchor-id="llm-dummy-functions">LLM dummy functions</h2>
<div id="cell-60" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MessageAdder():</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,to_add):</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.to_add <span class="op">=</span> to_add</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,<span class="op">**</span>message):</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> message.get(<span class="st">'content'</span>,<span class="dv">0</span>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(content,<span class="bu">int</span>):</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>            new_cont <span class="op">=</span> content <span class="op">+</span> <span class="va">self</span>.to_add</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(content,<span class="bu">str</span>):</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>            new_cont <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>content<span class="sc">}</span><span class="ss"> _ '</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f'content </span><span class="sc">{</span>content<span class="sc">}</span><span class="ss"> must be an int or a string'</span>)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'role'</span>:<span class="st">'adder'</span>,<span class="st">'content'</span>:new_cont}</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MessageAdder(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>to_add<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> MessageSum(<span class="op">**</span>kwargs):</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">sum</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key,value <span class="kw">in</span> kwargs.items():</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> value[<span class="st">'content'</span>]</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(count,<span class="bu">int</span>):</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span><span class="op">+=</span>count</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'role'</span>:<span class="st">'sum'</span>,<span class="st">'content'</span>:<span class="bu">sum</span>}</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FString():</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,s):</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.s<span class="op">=</span>s</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,<span class="op">**</span>kwargs):</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.s.<span class="bu">format</span>(<span class="op">**</span>kwargs)</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CycleOptions():</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,opts):</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.opts <span class="op">=</span> opts</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cycle <span class="op">=</span> itertools.cycle(opts)</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,<span class="op">*</span>args,<span class="op">**</span>kwargs):</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> args:</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>            kwargs <span class="op">=</span> args[<span class="dv">0</span>]</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> kwargs <span class="op">|</span> {<span class="st">'role'</span>:<span class="st">'chooser'</span>,<span class="st">'choice'</span>:<span class="bu">next</span>(<span class="va">self</span>.cycle)}</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'''CycleOptions(</span><span class="sc">{</span><span class="st">","</span><span class="sc">.</span>join(<span class="va">self</span>.opts)<span class="sc">}</span><span class="ss">)'''</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> is_mod():</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,mod):</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mod <span class="op">=</span> mod</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x):</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">%</span> <span class="va">self</span>.mod <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"is_mod(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>mod<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> is_eq():</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,val):</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.val <span class="op">=</span> val</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x):</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">==</span> <span class="va">self</span>.val</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"is_eq(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>val<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> concat(x,y,z):</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="ss">f'</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>z<span class="sc">}</span><span class="ss">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="self-loop" class="level2">
<h2 class="anchored" data-anchor-id="self-loop">self loop</h2>
<div id="cell-62" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is3(x):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">3</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'selfLoop'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> D:</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,MessageAdder(<span class="dv">1</span>),</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'End(**)'</span>,is3),</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'add1(**)'</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>            ])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams'):</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,trace <span class="kw">in</span> <span class="bu">enumerate</span>(d.run(<span class="bu">input</span><span class="op">=</span>{<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>})):</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this is how we can debug an infinite loop, have it stop after a certain number of iterations</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">5</span>: </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'role'</span>:<span class="st">'adder'</span>,<span class="st">'content'</span>: <span class="dv">3</span>}</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  role: human
  content: 0
output:
  role: human
  content: 0
---
name: add1
input:
  role: human
  content: 0
output:
  role: adder
  content: 1
---
name: add1
input:
  role: adder
  content: 1
output:
  role: adder
  content: 2
---
name: add1
input:
  role: adder
  content: 2
output:
  role: adder
  content: 3
---
name: End
input:
  role: adder
  content: 3
output:
  role: adder
  content: 3
---</code></pre>
</div>
</div>
</section>
<section id="choosing-tools" class="level2">
<h2 class="anchored" data-anchor-id="choosing-tools">Choosing tools</h2>
<div id="cell-65" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#with checkLogs(name='__main__'):</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is1(x):</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.match(<span class="st">'^1$'</span>,x[<span class="st">'choice'</span>])<span class="op">!=</span><span class="va">None</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is10(x):</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.match(<span class="st">'^10$'</span>,x[<span class="st">'choice'</span>])<span class="op">!=</span><span class="va">None</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any,Annotated</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomState(BaseModel):</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    model_config <span class="op">=</span> ConfigDict(extra<span class="op">=</span><span class="st">'allow'</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    mem1: Annotated[<span class="bu">list</span>[Any],<span class="bu">list</span>.append] <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mem1:list[Any] = list()</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># def add_mem1(self,value):</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     self.mem1.append(value)</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'choosing_tools'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>,state<span class="op">=</span>CustomState()) <span class="im">as</span> D:</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add1(**)'</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,MessageAdder(<span class="dv">1</span>),outputs<span class="op">=</span>[</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'choose_action(**)'</span>,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'state/mem1'</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add10'</span>,MessageAdder(<span class="dv">10</span>),outputs<span class="op">=</span>[</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'choose_action(**)'</span>,</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'state/mem10'</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'choose_action'</span>,CycleOptions([<span class="st">'1'</span>,<span class="st">'10'</span>,<span class="st">'1'</span>,<span class="st">'10'</span>,<span class="st">'finish'</span>]),</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'add1(**)'</span>,is1),</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'add10(**)'</span>,is10),</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'prep_end(final_out=content)'</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'prep_end'</span>,</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'State/mem1(ones=.)'</span>,</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">'State/mem10(last_ten=.)'</span>,</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">'End'</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>    )<span class="co"># an ID step</span></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-46-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-66" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams'):</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'count'</span>:<span class="dv">0</span>}):</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'final_out'</span>: <span class="dv">23</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ones'</span>: [{<span class="st">'role'</span>: <span class="st">'adder'</span>, <span class="st">'content'</span>: <span class="dv">1</span>},</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'role'</span>: <span class="st">'adder'</span>, <span class="st">'content'</span>: <span class="dv">2</span>},</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'role'</span>: <span class="st">'adder'</span>, <span class="st">'content'</span>: <span class="dv">13</span>}],</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'last_ten'</span>: {<span class="st">'role'</span>: <span class="st">'adder'</span>, <span class="st">'content'</span>: <span class="dv">23</span>}</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    },d.output</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: add1
input:
  role: human
  count: 0
output:
  role: adder
  content: 1
---
name: choose_action
input:
  role: adder
  content: 1
output:
  role: chooser
  content: 1
  choice: '1'
---
name: add1
input:
  role: chooser
  content: 1
  choice: '1'
output:
  role: adder
  content: 2
---
name: choose_action
input:
  role: adder
  content: 2
output:
  role: chooser
  content: 2
  choice: '10'
---
name: add10
input:
  role: chooser
  content: 2
  choice: '10'
output:
  role: adder
  content: 12
---
name: choose_action
input:
  role: adder
  content: 12
output:
  role: chooser
  content: 12
  choice: '1'
---
name: add1
input:
  role: chooser
  content: 12
  choice: '1'
output:
  role: adder
  content: 13
---
name: choose_action
input:
  role: adder
  content: 13
output:
  role: chooser
  content: 13
  choice: '10'
---
name: add10
input:
  role: chooser
  content: 13
  choice: '10'
output:
  role: adder
  content: 23
---
name: choose_action
input:
  role: adder
  content: 23
output:
  role: chooser
  content: 23
  choice: finish
---</code></pre>
</div>
</div>
</section>
<section id="parallel-flows" class="level2">
<h2 class="anchored" data-anchor-id="parallel-flows">parallel flows</h2>
<div id="cell-68" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'simple parallel'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,MessageAdder(<span class="dv">1</span>),outputs<span class="op">=</span>[<span class="st">'add2(**)'</span>,<span class="st">'add10(**)'</span>])</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add2'</span>,MessageAdder(<span class="dv">2</span>))</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add10'</span>,MessageAdder(<span class="dv">10</span>))</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'conc'</span>,concat,inputs<span class="op">=</span>[</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Start(x=content)'</span>,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'add2(z=content)'</span>,</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'add10(y=content)'</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'prep_out'</span>,inputs<span class="op">=</span>[</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'State/start(start_value)'</span>,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'conc(concatenation)'</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;State/start'</span>)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add1(**)'</span>)</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'prep_out-&gt;End'</span>)</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-48-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-69" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">1</span>}):</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'concatenation'</span>: <span class="st">'1_12_4'</span>, <span class="st">'start_value'</span>: {<span class="st">'role'</span>: <span class="st">'human'</span>, <span class="st">'content'</span>: <span class="dv">1</span>}},d.output</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.state.model_dump() <span class="op">==</span> {<span class="st">'start'</span>: {<span class="st">'role'</span>: <span class="st">'human'</span>, <span class="st">'content'</span>: <span class="dv">1</span>}} , d.state</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>d.state</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>BaseModelExtra(start={'role': 'human', 'content': 1})</code></pre>
</div>
</div>
</section>
<section id="nested" class="level2">
<h2 class="anchored" data-anchor-id="nested">Nested</h2>
<div id="cell-71" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add5'</span>) <span class="im">as</span> Add5:</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">5</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'End(**)'</span>])</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add10'</span>) <span class="im">as</span> Add10:</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add_first'</span>,Add5)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add_second'</span>,Add5)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add_first(**)'</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add_first-&gt;add_second(**)'</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add_second-&gt;End(**)'</span>)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add100'</span>) <span class="im">as</span> Add100:</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">100</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'End(**)'</span>])</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'paralell2'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> Parallel2:</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,MessageAdder(<span class="dv">1</span>))</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'flow'</span>):</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add10'</span>,Add10,inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add100'</span>,Add100,inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'End'</span>,MessageSum,inputs<span class="op">=</span>[<span class="st">'add10(y)'</span>,<span class="st">'add100(x)'</span>])</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>Add5.draw()</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>Add10.draw()</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>Add100.draw()</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>Parallel2.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-50-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-50-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-50-output-3.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-50-output-4.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-72" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>d.funcs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'add1': &lt;__main__.MessageAdder&gt;,
 'add2': &lt;__main__.MessageAdder&gt;,
 'add10': &lt;__main__.MessageAdder&gt;,
 'conc': &lt;function __main__.concat(x, y, z)&gt;}</code></pre>
</div>
</div>
<div id="cell-73" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> Parallel2()</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>}):</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>   trace.pprint()</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'sum'</span>, <span class="st">'content'</span>: <span class="dv">112</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  role: human
  content: 0
output:
  role: adder
  content: 1
---
name: add100.Start
input:
  role: adder
  content: 1
output:
  role: adder
  content: 1
---
name: add10.Start
input:
  role: adder
  content: 1
output:
  role: adder
  content: 1
---
name: add100.add
input:
  role: adder
  content: 1
output:
  role: adder
  content: 101
---
name: add10.add_first.Start
input:
  role: adder
  content: 1
output:
  role: adder
  content: 1
---
name: add100.End
input:
  role: adder
  content: 101
output:
  role: adder
  content: 101
---
name: add10.add_first.add
input:
  role: adder
  content: 1
output:
  role: adder
  content: 6
---
name: add100
input:
  role: adder
  content: 1
output:
  role: adder
  content: 101
---
name: add10.add_first.End
input:
  role: adder
  content: 6
output:
  role: adder
  content: 6
---
name: add10.add_first
input:
  role: adder
  content: 1
output:
  role: adder
  content: 6
---
name: add10.add_second.Start
input:
  role: adder
  content: 6
output:
  role: adder
  content: 6
---
name: add10.add_second.add
input:
  role: adder
  content: 6
output:
  role: adder
  content: 11
---
name: add10.add_second.End
input:
  role: adder
  content: 11
output:
  role: adder
  content: 11
---
name: add10.add_second
input:
  role: adder
  content: 6
output:
  role: adder
  content: 11
---
name: add10.End
input:
  role: adder
  content: 11
output:
  role: adder
  content: 11
---
name: add10
input:
  role: adder
  content: 1
output:
  role: adder
  content: 11
---
name: End
input:
  x:
    role: adder
    content: 101
  y:
    role: adder
    content: 11
output:
  role: sum
  content: 112
---</code></pre>
</div>
</div>
</section>
<section id="compound" class="level2">
<h2 class="anchored" data-anchor-id="compound">Compound</h2>
<div id="cell-75" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'paralell with choice'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> D:</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,MessageAdder(<span class="dv">1</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'flow'</span>):</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add10'</span>,Add10,inputs<span class="op">=</span>[<span class="st">'add1(**)'</span>])</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add100'</span>,Add100,inputs<span class="op">=</span>[<span class="st">'add1(**)'</span>])</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'sum'</span>,MessageSum,inputs<span class="op">=</span>[<span class="st">'add10(y)'</span>,<span class="st">'add100(x)'</span>])</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'sum-&gt;End'</span>)</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'sum-&gt;add1(**)'</span>,cond<span class="op">=</span>is112)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#EXPLAIN what are legal parallel cut</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-76" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams'):</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>}):</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trace.pprint()</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'sum'</span>, <span class="st">'content'</span>: <span class="dv">336</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-77" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add(a,b):</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">+</span>b</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Pow():</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,power):</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.power <span class="op">=</span> power</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,a):</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a<span class="op">**</span><span class="va">self</span>.power</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'Pow(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>power<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Add():</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,a):</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.a <span class="op">=</span> a</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,b):</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.a<span class="op">+</span>b</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'Add(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>a<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> IsModulo():</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,mod):</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mod <span class="op">=</span> mod</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,a):</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a<span class="op">%</span><span class="va">self</span>.mod<span class="op">==</span><span class="dv">0</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'IsModulo(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>mod<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EqualsTo():</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,value):</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> value</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,a):</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a<span class="op">==</span><span class="va">self</span>.value</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'EqualsTo(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>value<span class="sc">}</span><span class="ss">)'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'parallel decisions'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,outputs<span class="op">=</span>[<span class="st">'choice1'</span>,<span class="st">'choice2'</span>])</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'decision'</span>):</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'choice1'</span>,outputs<span class="op">=</span>[</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'square'</span>,IsModulo(<span class="dv">2</span>)),</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cube'</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'square'</span>,Pow(<span class="dv">2</span>),outputs<span class="op">=</span>[<span class="st">'end_choice1'</span>])</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'cube'</span>,Pow(<span class="dv">3</span>),outputs<span class="op">=</span>[<span class="st">'end_choice1'</span>])</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'choice2'</span>,outputs<span class="op">=</span>[</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'add2'</span>,IsModulo(<span class="dv">3</span>)),</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'add3'</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add2'</span>,Add(<span class="dv">2</span>),outputs<span class="op">=</span>[<span class="st">'end_choice2'</span>])</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add3'</span>,Add(<span class="dv">3</span>),outputs<span class="op">=</span>[<span class="st">'end_choice2'</span>])</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'sum'</span>,add,inputs<span class="op">=</span>[<span class="st">'end_choice1(a)'</span>,<span class="st">'end_choice2(b)'</span>],outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-56-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-79" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">2</span>):</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">9</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: add3
input:
  0: 2
output: 5
---
name: square
input:
  0: 2
output: 4
---
name: sum
input:
  b: 5
  a: 4
output: 9
---</code></pre>
</div>
</div>
<div id="cell-80" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">3</span>):</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">32</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: cube
input:
  0: 3
output: 27
---
name: add2
input:
  0: 3
output: 5
---
name: sum
input:
  b: 5
  a: 27
output: 32
---</code></pre>
</div>
</div>
<div id="cell-81" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Router'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> CompoundRouter:</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'flow'</span>):</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'square'</span>,Pow(<span class="dv">2</span>),inputs<span class="op">=</span>[<span class="st">'Start'</span>])</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'router'</span>,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span>[</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">'square(b=.)'</span>,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Start(a=.)'</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>                ],)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'router-&gt;add10(0=b)'</span>)</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'router-&gt;add100(0=b)'</span>,cond<span class="op">=</span>Condition(IsModulo(<span class="dv">2</span>),<span class="st">'(0=a)'</span>,name<span class="op">=</span><span class="st">'a%2==0'</span>))</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'router-&gt;add1000(0=b)'</span>,cond<span class="op">=</span>Condition(IsModulo(<span class="dv">3</span>),<span class="st">'(0=a)'</span>,name<span class="op">=</span><span class="st">'a%3==0'</span>))</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add10'</span>,Add(<span class="dv">10</span>),outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add100'</span>,Add(<span class="dv">100</span>),outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1000'</span>,Add(<span class="dv">1000</span>),outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>CompoundRouter.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-59-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-82" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>CompoundRouter()</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.run_all(<span class="dv">2</span>) <span class="op">==</span> <span class="dv">104</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.run_all(<span class="dv">3</span>) <span class="op">==</span> <span class="dv">1009</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.run_all(<span class="dv">5</span>) <span class="op">==</span> <span class="dv">35</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="overide-defines" class="level2">
<h2 class="anchored" data-anchor-id="overide-defines">Overide defines</h2>
<div id="cell-84" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-61-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-85" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D(add2<span class="op">=</span>Add(<span class="dv">10</span>))</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>d.draw()</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">6</span>):</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> <span class="dv">52</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-62-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>name: add2
input:
  0: 6
output: 16
---
name: square
input:
  0: 6
output: 36
---
name: sum
input:
  a: 36
  b: 16
output: 52
---</code></pre>
</div>
</div>
</section>
<section id="break-with-state" class="level2">
<h2 class="anchored" data-anchor-id="break-with-state">Break with state</h2>
<div id="cell-87" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserDBState(BaseModel):</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    history: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_to_history(<span class="va">self</span>, input_data: <span class="bu">str</span>):</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history.append(input_data)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_messages(messages):</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(messages)</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>is_3 <span class="op">=</span> <span class="kw">lambda</span> x: x<span class="op">==</span><span class="dv">3</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-88" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Answer to Life with Feedback'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>,state <span class="op">=</span> UserDBState()) <span class="im">as</span> D:</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;State/add_to_history(0=.)'</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Node1'</span>,count_messages,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>      inputs<span class="op">=</span>[<span class="st">'Start(_)'</span>],</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>      outputs<span class="op">=</span>[</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>          (<span class="st">'End'</span>,is_3),</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">'Break'</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>          ]</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'State/history-&gt;Node1'</span>)</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Break'</span>,is_break <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Break-&gt;State/add_to_history(0=.)'</span>)</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Break-&gt;Node1(_=.)'</span>)</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-64-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-89" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>d1<span class="op">=</span>D()</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> [<span class="st">'hello'</span>,<span class="st">'world'</span>,<span class="st">'how'</span>,<span class="st">'are'</span>,<span class="st">'you'</span>]</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> message <span class="kw">in</span> messages:</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d1.run(message):</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d1.state.history <span class="op">==</span> [<span class="st">'hello'</span>,<span class="st">'world'</span>,<span class="st">'how'</span>,<span class="st">'are'</span>,<span class="st">'you'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="parallel-with-break" class="level2">
<h2 class="anchored" data-anchor-id="parallel-with-break">Parallel with break</h2>
<div id="cell-91" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add5'</span>) <span class="im">as</span> Add5:</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">5</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'End(**)'</span>])</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add10'</span>) <span class="im">as</span> Add10:</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add_first'</span>,Add5)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add_second'</span>,Add5)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add_first(**)'</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add_first-&gt;add_second(**)'</span>)</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add_second-&gt;End(**)'</span>)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add100'</span>) <span class="im">as</span> Add100:</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">100</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'End(**)'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-92" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name="__main__"):</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'paralell with break'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> D:</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,MessageAdder(<span class="dv">1</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'flow'</span>):</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add10'</span>,Add10,inputs<span class="op">=</span>[<span class="st">'add1(**)'</span>])</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add100'</span>,Add100,inputs<span class="op">=</span>[<span class="st">'add1(**)'</span>])</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'sum'</span>,MessageSum,inputs<span class="op">=</span>[<span class="st">'add10(y)'</span>,<span class="st">'add100(x)'</span>])</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'sum-&gt;End'</span>)</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'sum-&gt;break'</span>,cond<span class="op">=</span>is112)</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'break-&gt;add1(**)'</span>)</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-67-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-93" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> d.run_all({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>})</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> output <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'sum'</span>, <span class="st">'content'</span>: <span class="dv">112</span>}</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished <span class="op">==</span> <span class="va">False</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>new_input <span class="op">=</span> {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">157</span>}</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(new_input):</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> d.output</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> output <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'sum'</span>, <span class="st">'content'</span>: <span class="dv">426</span>} , output</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="nested-breaks" class="level2">
<h2 class="anchored" data-anchor-id="nested-breaks">Nested breaks</h2>
<div id="cell-95" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_3(x):</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">3</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_10(x):</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">10</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'inner_break'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> InnerD:</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">0</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'break'</span>])</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,outputs<span class="op">=</span>[<span class="st">'add(**)'</span>,(<span class="st">'End'</span>,is_3)])</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'outer_break'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> OuterD:</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'inner'</span>,InnerD,inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'break'</span>])</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,outputs<span class="op">=</span>[<span class="st">'inner(**)'</span>,(<span class="st">'End'</span>,is_10)])</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>InnerD.draw()</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>OuterD.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-69-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-69-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>what we expect to happen here, is that: * We will enter the inner diagram, we wont exit it until we get a 3 * once we get a 3 we will exit the inerdiagram and hit the break on the outer diagram * we will only exit the outer diagram when we get a 10</p>
<p>So to exit, we will need to get a 3 followed by a 10</p>
<div id="cell-97" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> [</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>},</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">1</span>},</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">2</span>},</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">3</span>}, <span class="co"># exit inner the first time</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">5</span>}, <span class="co"># go to outer and then to inner again</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">10</span>}, <span class="co"># 10 wont get us out of the inner diagram</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">3</span>}, <span class="co"># exit inner the second time</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">10</span>}, <span class="co"># 10 will get us out of the outer diagram</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>outer_d <span class="op">=</span> OuterD()</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span> <span class="op">=</span> inputs.pop(<span class="dv">0</span>)</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> outer_d.run(<span class="bu">input</span>):</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>trace<span class="sc">.</span>node_name[<span class="dv">0</span>]<span class="sc">:&lt;16}</span><span class="ss"> == </span><span class="sc">{</span>trace<span class="sc">.</span>input_<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> outer_d.finished:</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> outer_d.output <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'human'</span>, <span class="st">'content'</span>: <span class="dv">10</span>}</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> inputs <span class="op">==</span> []</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Start            == {'role': 'human', 'content': 0}
inner            == {'role': 'human', 'content': 0}
inner            == {'role': 'human', 'content': 0}
inner            == {'role': 'human', 'content': 1}
inner            == {'role': 'human', 'content': 1}
inner            == {'role': 'human', 'content': 2}
inner            == {'role': 'human', 'content': 2}
inner            == {'role': 'human', 'content': 3}
inner            == {0: {'role': 'human', 'content': 3}}
inner            == {'role': 'human', 'content': 3}
break            == {'role': 'human', 'content': 5}
inner            == {'role': 'human', 'content': 5}
inner            == {'role': 'human', 'content': 5}
inner            == {'role': 'human', 'content': 10}
inner            == {'role': 'human', 'content': 10}
inner            == {'role': 'human', 'content': 3}
inner            == {0: {'role': 'human', 'content': 3}}
inner            == {'role': 'human', 'content': 3}
break            == {'role': 'human', 'content': 10}
End              == {0: {'role': 'human', 'content': 10}}</code></pre>
</div>
</div>
</section>
<section id="cant-break-inside-parallel" class="level2">
<h2 class="anchored" data-anchor-id="cant-break-inside-parallel">Cant break inside parallel</h2>
<div id="cell-99" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>,match<span class="op">=</span><span class="st">'Breakpoints are not allowed in a Flow diagram'</span>):</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Define(<span class="st">'simple parallel'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> d:</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add1'</span>,MessageAdder(<span class="dv">1</span>))</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add2'</span>,InnerD)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add10'</span>,MessageAdder(<span class="dv">10</span>))</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'conc'</span>,concat)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'prep_out'</span>)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Start-&gt;State/start'</span>)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Start-&gt;conc(x=concatenation)'</span>)</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Start-&gt;add1'</span>)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'add1-&gt;add10'</span>)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'add1-&gt;add2'</span>)</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'add10-&gt;conc(y=concatenation)'</span>)</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'add2-&gt;conc(z=concatenation)'</span>)</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'conc-&gt;prep_out(concatenation=concatenation)'</span>)</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'State/start-&gt;prep_out(start_value=start)'</span>)</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'prep_out-&gt;End'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-71-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="far-ancestor-writing-to-state" class="level2">
<h2 class="anchored" data-anchor-id="far-ancestor-writing-to-state">Far ancestor writing to state</h2>
<div id="cell-101" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> pairwise</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-102" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomState(BaseModel):</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    model_config <span class="op">=</span> ConfigDict(extra<span class="op">=</span><span class="st">'allow'</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    history: Annotated[<span class="bu">list</span>[Any],<span class="bu">list</span>.append] <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'far ancestor writing to state'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>,state<span class="op">=</span>CustomState()) <span class="im">as</span> D:</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> MessageAdder(<span class="dv">0</span>)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u <span class="kw">in</span> [<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>]:</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>        V(u,a)</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>        E(<span class="ss">f'</span><span class="sc">{</span>u<span class="sc">}</span><span class="ss">-&gt;state/history'</span>)</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u,v <span class="kw">in</span> pairwise([<span class="st">'Start'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="st">'End'</span>]):</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>        E(<span class="ss">f'</span><span class="sc">{</span>u<span class="sc">}</span><span class="ss">-&gt;</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">(**)'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-103" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='__main__'):</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>}):</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.state.model_dump() <span class="op">==</span> {<span class="st">'history'</span>: [{<span class="st">'role'</span>: <span class="st">'adder'</span>, <span class="st">'content'</span>: <span class="dv">0</span>},</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>                               {<span class="st">'role'</span>: <span class="st">'adder'</span>, <span class="st">'content'</span>: <span class="dv">0</span>},</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>                               {<span class="st">'role'</span>: <span class="st">'adder'</span>, <span class="st">'content'</span>: <span class="dv">0</span>}]}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="initializing-state" class="level2">
<h2 class="anchored" data-anchor-id="initializing-state">Initializing state</h2>
<div id="cell-105" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'init_state_no_clash'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> NoClash:</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus,</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start(x)'</span>,<span class="st">'State/init(y)'</span>],</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'State/first_sum'</span>]</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,inputs<span class="op">=</span>[<span class="st">'add1(x)'</span>])</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add2'</span>,plus,</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'break(x)'</span>,<span class="st">'State/first_sum(y)'</span>],</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-106" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> [</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> []</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>NoClash()</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>d.state.init<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span>inputs.pop(<span class="dv">0</span>)):</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    outputs.append(d.output)</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> d.finished:</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> outputs <span class="op">==</span> [<span class="dv">1010</span>,<span class="dv">1110</span>],outputs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="nested-state-basemodels" class="level2">
<h2 class="anchored" data-anchor-id="nested-state-basemodels">Nested state basemodels</h2>
<div id="cell-108" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-109" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SubState(BaseModel):</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    sub_init : <span class="bu">int</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> square(<span class="va">self</span>):</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.sub_init<span class="op">**</span><span class="dv">2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-110" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>NoClash()</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>d.state <span class="op">=</span> d.state.model_copy(update<span class="op">=</span>{<span class="st">'init'</span>:<span class="dv">100</span>,<span class="st">'sub_obj'</span>:SubState(sub_init<span class="op">=</span><span class="dv">10</span>)})</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">10</span>):</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-111" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.state.sub_obj.square() <span class="op">==</span> <span class="dv">100</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="init-with-state-clash" class="level2">
<h2 class="anchored" data-anchor-id="init-with-state-clash">Init with state clash</h2>
<div id="cell-113" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StateRequiresInit(BaseModel):</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    init : <span class="bu">int</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'init_state_with_clash'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>,state<span class="op">=</span>StateRequiresInit(init<span class="op">=</span><span class="dv">0</span>)) <span class="im">as</span> D:</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus,</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start(x)'</span>,<span class="st">'State/init(y)'</span>],</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'State/init'</span>]</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,inputs<span class="op">=</span>[<span class="st">'add1(x)'</span>])</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add2'</span>,plus,</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'break(x)'</span>,<span class="st">'State/init(y)'</span>],</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-81-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-114" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> [</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> []</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>d.state.init<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># note that the internal state overides the state given to the run method</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that is why after the breakpoint, state.init is 1010 and not 1000</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span>inputs.pop(<span class="dv">0</span>)):</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    outputs.append(d.output)</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> d.finished:</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> outputs <span class="op">==</span> [<span class="dv">1010</span>,<span class="dv">1110</span>],outputs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-115" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>d.state</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>StateRequiresInit(init=1010)</code></pre>
</div>
</div>
<section id="missing-input-state" class="level3">
<h3 class="anchored" data-anchor-id="missing-input-state">Missing input state</h3>
<div id="cell-117" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> NoClash()</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pytest.raises(<span class="pp">AttributeError</span>,match<span class="op">=</span><span class="st">'''object has no attribute '''</span>):</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # with checkLogs(name='stringdale.diagrams'):</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="stateful-nodes-and-serialization" class="level2">
<h2 class="anchored" data-anchor-id="stateful-nodes-and-serialization">Stateful nodes and Serialization</h2>
<div id="cell-119" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MessageCounter():</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history <span class="op">=</span> []</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,message):</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history.append(message[<span class="st">'content'</span>])</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'role'</span>:<span class="st">'counter'</span>,<span class="st">'content'</span>:<span class="bu">str</span>(<span class="va">self</span>.history)}</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MessageCounter(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>history<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'&lt;at #</span><span class="sc">{</span><span class="bu">id</span>(<span class="va">self</span>)<span class="sc">}</span><span class="ss">&gt;</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="fu">__str__</span>()<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset(<span class="va">self</span>):</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history <span class="op">=</span> []</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dump_state(<span class="va">self</span>):</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.history</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_state(<span class="va">self</span>,state_object):</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history <span class="op">=</span> state_object</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-120" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomState(BaseModel):</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    timer:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    counter_outputs: Annotated[<span class="bu">list</span>[Any],<span class="bu">list</span>.append] <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> count_down(<span class="va">self</span>,value):</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.timer <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>,<span class="va">self</span>.timer<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.timer</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_timeout(x):</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x[<span class="st">'timer'</span>] <span class="op">==</span> <span class="st">'TimerOut'</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'stateful_adder'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>,state<span class="op">=</span>CustomState()) <span class="im">as</span> StateFulAdder:</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'router'</span>,</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start(message)'</span>,<span class="st">'state/timer(timer)'</span>],</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'adder(message=message)'</span>]</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'router-&gt;End'</span>,cond<span class="op">=</span>is_timeout)</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'adder'</span>,MessageCounter(),</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'state/counter_outputs'</span>,<span class="st">'state/count_down'</span>])</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,inputs<span class="op">=</span>[<span class="st">'adder'</span>],outputs<span class="op">=</span>[<span class="st">'router(message)'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-121" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make 2 copies of the diagram</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>copy1 <span class="op">=</span> StateFulAdder()</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>copy2 <span class="op">=</span> StateFulAdder()</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co"># run copy1</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>copy1.state.timer<span class="op">=</span><span class="dv">4</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> copy1.run({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">1</span>}):</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> copy1.output <span class="op">==</span> {<span class="st">'role'</span>:<span class="st">'counter'</span>,<span class="st">'content'</span>:<span class="st">'[1]'</span>},copy1.output</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> copy1.finished <span class="op">==</span> <span class="va">False</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure copy2 didnt change</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> copy2.finished <span class="op">==</span> <span class="va">None</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> copy2.state <span class="op">==</span> CustomState()</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a><span class="co"># load the state from copy1 into copy2</span></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>saved_state <span class="op">=</span> copy1.dump_state()</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>copy2.load_state(saved_state)</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a><span class="co"># check copy2 has the same output as copy1</span></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> copy2.output <span class="op">==</span> copy1.output</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> copy2.finished <span class="op">==</span> copy1.finished</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Continue copy1 and copy2 with different inputs</span></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we dont need to pass the state again, it is preserved from the copy1 run</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>res1 <span class="op">=</span> copy1.run_all({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">2</span>})</span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>res2 <span class="op">=</span> copy2.run_all({<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">3</span>})</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure we got different outputs</span></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> res1 <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'counter'</span>, <span class="st">'content'</span>: <span class="st">'[1, 2]'</span>}, res1</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> res2 <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'counter'</span>, <span class="st">'content'</span>: <span class="st">'[1, 3]'</span>}, res2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="conflicting-ports" class="level2">
<h2 class="anchored" data-anchor-id="conflicting-ports">Conflicting ports</h2>
<div id="cell-123" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>,match<span class="op">=</span><span class="st">'has conflicting input ports'</span>) <span class="im">as</span> e:</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Define(<span class="st">'conflicting_ports'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> d:</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'Conditional_node'</span>,plus1)</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Start-&gt;Conditional_node'</span>)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'Option1'</span>)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'Default_option'</span>)</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># by default, all edges we define are conditional,</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we can specify a condition for an edge by passing a function to the cond argument</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Conditional_node-&gt;Option1'</span>,cond<span class="op">=</span>mod2)</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># not passing a condition means that this edge is the default edge</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># each node that has outgoing conditional edges must have at least one default edge</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Conditional_node-&gt;Default_option'</span>)</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we can also define a flow edge by passing scope='flow' to the E function</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'Parallel_node1'</span>,plus1)</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'Parallel_node2'</span>,plus2)</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Option1-&gt;Parallel_node1'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Option1-&gt;Parallel_node2'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Parallel_node1-&gt;Parallel_end'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Parallel_node2-&gt;Parallel_end'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Parallel_end-&gt;End'</span>)</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Default_option-&gt;End'</span>)</span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we can also read and write to state by using the State node in edge definitions.</span></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the port of the State node is the key of the state we would like to read from or write to</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the port of the node we are connecting to is the value we would like to write to the state</span></span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if we want to read from the state, we can use the State.port notation</span></span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'Start-&gt;State/start'</span>)</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'State/start-&gt;End(start_state)'</span>)</span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(e.value.args[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-88-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Parallel_end has conflicting input ports '[0]'
between its father nodes and/or state {'input_state_ports': [], 'Parallel_node1': [0], 'Parallel_node2': [0]}</code></pre>
</div>
</div>
</section>
<section id="exception-during-condition" class="level2">
<h2 class="anchored" data-anchor-id="exception-during-condition">Exception during condition</h2>
<div id="cell-125" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'selfLoop'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> D:</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is12(x):</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">12</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> istoobig(x):</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[<span class="st">'shmontest'</span>] <span class="op">&gt;</span> <span class="dv">12</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> zeroup (x):</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>        x[<span class="st">'content'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'too_big'</span>)</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'adder'</span>,MessageAdder(<span class="dv">4</span>),</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>,<span class="st">'too_big(**)'</span>],</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'End'</span>,is12),</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'too_big(**)'</span>,istoobig),</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'adder(**)'</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'too_big'</span>,zeroup)</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>,match<span class="op">=</span><span class="st">'When choosing next node after adder'</span>) <span class="im">as</span> e:</span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i,trace <span class="kw">in</span> <span class="bu">enumerate</span>(d.run(<span class="bu">input</span><span class="op">=</span>{<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>})):</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(e.value.args[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>When choosing next node after adder:
Condition function &lt;function istoobig&gt;({'role': 'adder', 'content': 4}) returned 
KeyError:''shmontest''</code></pre>
</div>
</div>
<section id="defining-conditional-edges-after-node-definition" class="level3">
<h3 class="anchored" data-anchor-id="defining-conditional-edges-after-node-definition">defining conditional edges after node definition</h3>
<div id="cell-127" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pytest.raises(<span class="pp">ValueError</span>,match<span class="op">=</span><span class="st">'Edge to_big-&gt;adder already exists'</span>) <span class="im">as</span> e:</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Define(<span class="st">'selfLoop'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> D:</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> is12(x):</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">12</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> istobig(x):</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">&gt;</span> <span class="dv">12</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> zeroup (x):</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="dv">0</span>: (<span class="st">'adder'</span>, <span class="dv">0</span>)}</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'to_big'</span>)</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'adder'</span>,MessageAdder(<span class="dv">4</span>),</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span>[<span class="st">'Start'</span>,<span class="st">'to_big'</span>],</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>            outputs<span class="op">=</span>[</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>                (<span class="st">'End'</span>,is12),</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>                (<span class="st">'to_big'</span>,istobig),</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">'adder'</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>                ])</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>        E(<span class="st">'to_big-&gt;adder'</span>, <span class="kw">lambda</span> x: zeroup(x[<span class="st">'content'</span>]))</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(e.value.args[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-90-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>When adding edge 'to_big-&gt;adder' with condition &lt;function &lt;lambda&gt;&gt;, type None and edge_data {'edge_type': 'edge', 'mapping': {0: ('.',)}}
Edge to_big-&gt;adder already exists, edge: to_big-&gt;adder
</code></pre>
</div>
</div>
</section>
</section>
<section id="batch-processing" class="level2">
<h2 class="anchored" data-anchor-id="batch-processing">Batch processing</h2>
<p>Regular batch processing</p>
<div id="cell-130" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MakeItems:</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,num_items,delta,sleep):</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_items <span class="op">=</span> num_items</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.delta <span class="op">=</span> delta</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sleep <span class="op">=</span> sleep</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,x):</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="va">self</span>.sleep)</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [x<span class="op">+</span>i<span class="op">*</span><span class="va">self</span>.delta <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_items)]</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MakeItems(num_items=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>num_items<span class="sc">}</span><span class="ss">,delta=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>delta<span class="sc">}</span><span class="ss">,sleep=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>sleep<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MakeItemsAsync:</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,num_items,delta,sleep):</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_items <span class="op">=</span> num_items</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.delta <span class="op">=</span> delta</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sleep <span class="op">=</span> sleep</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,x):</span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> asyncio.sleep(<span class="va">self</span>.sleep)</span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [x<span class="op">+</span>i<span class="op">*</span><span class="va">self</span>.delta <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_items)]</span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MakeItemsAsync(num_items=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>num_items<span class="sc">}</span><span class="ss">,delta=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>delta<span class="sc">}</span><span class="ss">,sleep=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>sleep<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_to_arr(arr,x):</span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [a<span class="op">+</span>x <span class="cf">for</span> a <span class="kw">in</span> arr]</span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sort(arr):</span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(arr)</span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> asort(arr):</span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(arr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-131" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'batch_processing_sync'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'make_items'</span>,MakeItems(<span class="dv">3</span>,delta <span class="op">=</span> <span class="dv">1</span>,sleep <span class="op">=</span> <span class="fl">0.1</span>),inputs<span class="op">=</span>[<span class="st">'Start'</span>])</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'more_items'</span>,MakeItems(<span class="dv">3</span>,delta <span class="op">=</span> <span class="dv">10</span>,sleep <span class="op">=</span> <span class="fl">0.1</span>),</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>        for_each<span class="op">=</span>[<span class="st">'x'</span>],</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'make_items(x)'</span>],</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>], flat<span class="op">=</span><span class="va">True</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-132" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with  checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">20</span>, <span class="dv">21</span>, <span class="dv">22</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 0
output: 0
---
name: make_items
input:
  0: 0
output: [0, 1, 2]
---
name: more_items[1]
input:
  x: 1
output: [1, 11, 21]
---
name: more_items[2]
input:
  x: 2
output: [2, 12, 22]
---
name: more_items[0]
input:
  x: 0
output: [0, 10, 20]
---
name: End
input:
  0: [1, 11, 21, 2, 12, 22, 0, 10, 20]
output: [0, 1, 2, 10, 11, 12, 20, 21, 22]
---</code></pre>
</div>
</div>
<section id="batch-processing-with-async-functions" class="level3">
<h3 class="anchored" data-anchor-id="batch-processing-with-async-functions">Batch processing with async functions</h3>
<div id="cell-134" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'batch_processing_async'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'make_items'</span>,MakeItemsAsync(<span class="dv">3</span>,delta <span class="op">=</span> <span class="dv">1</span>,sleep <span class="op">=</span> <span class="fl">0.1</span>),inputs<span class="op">=</span>[<span class="st">'Start'</span>])</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'more_items'</span>,MakeItemsAsync(<span class="dv">3</span>,delta <span class="op">=</span> <span class="dv">10</span>,sleep <span class="op">=</span> <span class="fl">0.1</span>),</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>        for_each<span class="op">=</span>[<span class="st">'x'</span>],</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'make_items(x)'</span>],</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>], flat<span class="op">=</span><span class="va">True</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,asort)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-135" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with  checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">20</span>, <span class="dv">21</span>, <span class="dv">22</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 0
output: 0
---
name: make_items
input:
  0: 0
output: [0, 1, 2]
---
name: more_items[0]
input:
  x: 0
output: [0, 10, 20]
---
name: more_items[1]
input:
  x: 1
output: [1, 11, 21]
---
name: more_items[2]
input:
  x: 2
output: [2, 12, 22]
---
name: End
input:
  0: [0, 10, 20, 1, 11, 21, 2, 12, 22]
output: [0, 1, 2, 10, 11, 12, 20, 21, 22]
---</code></pre>
</div>
</div>
<div id="cell-136" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MakeItems:</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,num_items,delta,sleep):</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_items <span class="op">=</span> num_items</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.delta <span class="op">=</span> delta</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sleep <span class="op">=</span> sleep</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,x):</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="va">self</span>.sleep)</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [x<span class="op">+</span>i<span class="op">*</span><span class="va">self</span>.delta <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_items)]</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MakeItems(num_items=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>num_items<span class="sc">}</span><span class="ss">,delta=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>delta<span class="sc">}</span><span class="ss">,sleep=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>sleep<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MakeItemsAsync:</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,num_items,delta,sleep):</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_items <span class="op">=</span> num_items</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.delta <span class="op">=</span> delta</span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sleep <span class="op">=</span> sleep</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,x):</span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> asyncio.sleep(<span class="va">self</span>.sleep)</span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [x<span class="op">+</span>i<span class="op">*</span><span class="va">self</span>.delta <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_items)]</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MakeItemsAsync(num_items=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>num_items<span class="sc">}</span><span class="ss">,delta=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>delta<span class="sc">}</span><span class="ss">,sleep=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>sleep<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_all(<span class="op">*</span>arr):</span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(arr)</span>
<span id="cb122-30"><a href="#cb122-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-31"><a href="#cb122-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_to_arr(arr,x):</span>
<span id="cb122-32"><a href="#cb122-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [a<span class="op">+</span>x <span class="cf">for</span> a <span class="kw">in</span> arr]</span>
<span id="cb122-33"><a href="#cb122-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-34"><a href="#cb122-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb122-35"><a href="#cb122-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb122-36"><a href="#cb122-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-37"><a href="#cb122-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sort(arr):</span>
<span id="cb122-38"><a href="#cb122-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(arr)</span>
<span id="cb122-39"><a href="#cb122-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-40"><a href="#cb122-40" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> asort(arr):</span>
<span id="cb122-41"><a href="#cb122-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(arr)</span>
<span id="cb122-42"><a href="#cb122-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-43"><a href="#cb122-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> concat(arr1,arr2):</span>
<span id="cb122-44"><a href="#cb122-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arr1<span class="op">+</span>arr2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="cartesian-product-of-input-streams" class="level3">
<h3 class="anchored" data-anchor-id="cartesian-product-of-input-streams">Cartesian product of input streams</h3>
<div id="cell-138" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'batch_processing_sleep_product'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'one'</span>,MakeItemsAsync(<span class="dv">2</span>,<span class="dv">1</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start(0=1)'</span>])</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'two'</span>,MakeItemsAsync(<span class="dv">2</span>,<span class="dv">100</span>,sleep<span class="op">=</span><span class="fl">0.10</span>),inputs<span class="op">=</span>[<span class="st">'Start(0=2)'</span>])</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'three'</span>,MakeItemsAsync(<span class="dv">2</span>,<span class="dv">10000</span>,sleep<span class="op">=</span><span class="fl">0.2</span>),inputs<span class="op">=</span>[<span class="st">'Start(0=3)'</span>])</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'sum'</span>,sum_all,inputs<span class="op">=</span>[<span class="st">'one(0)'</span>,<span class="st">'two(1)'</span>,<span class="st">'three(2)'</span>],for_each<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'sum'</span>])</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-97-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-139" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="dv">1</span>:<span class="dv">10</span>,<span class="dv">2</span>:<span class="dv">1000</span>,<span class="dv">3</span>:<span class="dv">100000</span>}):</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trace.pprint()</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="dv">101010</span>, <span class="dv">101011</span>, <span class="dv">101110</span>, <span class="dv">101111</span>, <span class="dv">111010</span>, <span class="dv">111011</span>, <span class="dv">111110</span>, <span class="dv">111111</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="using-for_each-with-both-stream-and-non-stream-inputs" class="level2">
<h2 class="anchored" data-anchor-id="using-for_each-with-both-stream-and-non-stream-inputs">Using for_each with both stream and non stream inputs</h2>
<div id="cell-141" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'batch_processing_comb'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'non_stream_first'</span>,add_to_arr,inputs<span class="op">=</span>[<span class="st">'Start(arr)'</span>,<span class="st">'State/x(x)'</span>])</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'stream_first'</span>,MakeItemsAsync(<span class="dv">3</span>,<span class="dv">10</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start(x)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>],flat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'non_stream_second'</span>,add_to_arr,inputs<span class="op">=</span>[<span class="st">'non_stream_first(_)'</span>,<span class="st">'stream_first(arr)'</span>,<span class="st">'State/y(x)'</span>])</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'stream_second'</span>,add_to_arr,inputs<span class="op">=</span>[<span class="st">'stream_first(x)'</span>,<span class="st">'non_stream_first(arr)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>],flat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Concat'</span>,concat,inputs<span class="op">=</span>[<span class="st">'non_stream_second(0)'</span>,<span class="st">'stream_second(1)'</span>])</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'Concat'</span>])</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>D.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-99-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-142" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale.base <span class="im">import</span> BaseModelExtra</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-143" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>d.state <span class="op">=</span> BaseModelExtra(x<span class="op">=</span><span class="dv">100</span>,y<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run([<span class="dv">0</span>]):</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="dv">100</span>, <span class="dv">110</span>, <span class="dv">120</span>, <span class="dv">1000</span>, <span class="dv">1010</span>, <span class="dv">1020</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: [0]
output: [0]
---
name: non_stream_first
input:
  arr: [0]
  x: 100
output: [100]
---
name: stream_first[0]
input:
  x: 0
output: [0, 10, 20]
---
name: non_stream_second
input:
  arr: [0, 10, 20]
  x: 1000
output: [1000, 1010, 1020]
---
name: stream_second[0]
input:
  x: 0
  arr: [100]
output: [100]
---
name: stream_second[2]
input:
  x: 20
  arr: [100]
output: [120]
---
name: stream_second[1]
input:
  x: 10
  arr: [100]
output: [110]
---
name: Concat
input:
  0: [1000, 1010, 1020]
  1: [100, 120, 110]
output: [1000, 1010, 1020, 100, 120, 110]
---
name: End
input:
  0: [1000, 1010, 1020, 100, 120, 110]
output: [100, 110, 120, 1000, 1010, 1020]
---</code></pre>
</div>
</div>
</section>
<section id="nested-diagrams-in-foreach" class="level2">
<h2 class="anchored" data-anchor-id="nested-diagrams-in-foreach">Nested diagrams in foreach</h2>
<div id="cell-145" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> add_sleep(x):</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="fl">0.1</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-146" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'async_adder'</span>)<span class="im">as</span> AsyncAdd:</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,add_sleep,inputs<span class="op">=</span>[<span class="st">'Start(x=x)'</span>],outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>AsyncAdd.draw()</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>async_add<span class="op">=</span>AsyncAdd()</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> async_add.run({<span class="st">'x'</span>:<span class="dv">0</span>}):</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-103-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  x: 0
output:
  x: 0
---
name: add
input:
  x: 0
output: 1
---
name: End
input:
  0: 1
output: 1
---</code></pre>
</div>
</div>
<div id="cell-147" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'nested_foreach'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'generate'</span>,MakeItemsAsync(<span class="dv">3</span>,<span class="dv">10</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,AsyncAdd,inputs<span class="op">=</span>[<span class="st">'generate(x=.)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>])</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'add'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-148" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'x'</span>:<span class="dv">0</span>}):</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="dv">1</span>, <span class="dv">11</span>, <span class="dv">21</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  x: 0
output:
  x: 0
---
name: generate
input:
  x: 0
output: [0, 10, 20]
---
name: add[2].Start
input:
  x: 20
output:
  x: 20
---
name: add[1].Start
input:
  x: 10
output:
  x: 10
---
name: add[0].Start
input:
  x: 0
output:
  x: 0
---
name: add[2].add
input:
  x: 20
output: 21
---
name: add[1].add
input:
  x: 10
output: 11
---
name: add[1].End
input:
  0: 11
output: 11
---
name: add[2].End
input:
  0: 21
output: 21
---
name: add[1]
input:
  x: 10
output: 11
---
name: add[0].add
input:
  x: 0
output: 1
---
name: add[2]
input:
  x: 20
output: 21
---
name: add[0].End
input:
  0: 1
output: 1
---
name: add[0]
input:
  x: 0
output: 1
---
name: End
input:
  0: [11, 21, 1]
output: [1, 11, 21]
---</code></pre>
</div>
</div>
</section>
<section id="nested-decision-diagrams-under-foreach" class="level2">
<h2 class="anchored" data-anchor-id="nested-decision-diagrams-under-foreach">Nested decision diagrams under foreach</h2>
<div id="cell-150" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Inner decision'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> InnerD:</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,add_sleep,inputs<span class="op">=</span>[<span class="st">'Start(x=x)'</span>],outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Outer decision'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'decision'</span>) <span class="im">as</span> OuterD:</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'inner'</span>,InnerD,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Nested foreach'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> NestedD:</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'generate'</span>,MakeItemsAsync(<span class="dv">3</span>,<span class="dv">10</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start'</span>])</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'inner'</span>,OuterD,inputs<span class="op">=</span>[<span class="st">'generate(x=.)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>])</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'inner'</span>])</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>NestedD.draw(recursive<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-106-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-106-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="015_diagram_unit_tests_files/figure-html/cell-106-output-3.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-151" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> NestedD()</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>name: Start
input:
  0: 0
output: 0
---
name: generate
input:
  0: 0
output: [0, 10, 20]
---
name: inner[1].Start
input:
  x: 10
output:
  x: 10
---
name: inner[0].Start
input:
  x: 0
output:
  x: 0
---
name: inner[2].Start
input:
  x: 20
output:
  x: 20
---
name: inner[0].inner.Start
input:
  0:
    x: 0
output:
  x: 0
---
name: inner[1].inner.Start
input:
  0:
    x: 10
output:
  x: 10
---
name: inner[2].inner.Start
input:
  0:
    x: 20
output:
  x: 20
---
name: inner[0].inner.add
input:
  x: 0
output: 1
---
name: inner[0].inner.End
input:
  0: 1
output: 1
---
name: inner[1].inner.add
input:
  x: 10
output: 11
---
name: inner[2].inner.add
input:
  x: 20
output: 21
---
name: inner[0].inner
input:
  0:
    x: 0
output: 1
---
name: inner[2].inner.End
input:
  0: 21
output: 21
---
name: inner[0].End
input:
  0: 1
output: 1
---
name: inner[1].inner.End
input:
  0: 11
output: 11
---
name: inner[2].inner
input:
  0:
    x: 20
output: 21
---
name: inner[1].inner
input:
  0:
    x: 10
output: 11
---
name: inner[0]
input:
  x: 0
output: 1
---
name: inner[1].End
input:
  0: 11
output: 11
---
name: inner[2].End
input:
  0: 21
output: 21
---
name: inner[1]
input:
  x: 10
output: 11
---
name: inner[2]
input:
  x: 20
output: 21
---
name: End
input:
  0: [1, 11, 21]
output: [1, 11, 21]
---</code></pre>
</div>
</div>
</section>
<section id="text-splitting" class="level2">
<h2 class="anchored" data-anchor-id="text-splitting">Text splitting</h2>
<div id="cell-153" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>sample_doc <span class="op">=</span> {<span class="st">'text'</span>:<span class="st">"""</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="st">The elephant is one of the most remarkable creatures on Earth. Known for their intelligence and complex social structures, elephants form deep family bonds that can last a lifetime. These gentle giants possess remarkable memory capabilities and demonstrate emotional behaviors like mourning their dead. Their distinctive trunks, containing over 40,000 muscles, serve multiple purposes from gathering food to expressing affection.</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="st">The arctic fox is a fascinating animal that has adapted perfectly to life in the extreme cold. During winter, its thick white fur provides both insulation and camouflage in the snowy landscape, while in summer its coat turns brownish-gray to blend with the tundra. These resourceful predators can survive temperatures as low as -50°C (-58°F) and will travel vast distances across the Arctic ice in search of food, often following polar bears to scavenge their leftovers.</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="st">The octopus stands out as one of the ocean's most intelligent invertebrates. With nine brains (one central brain and eight additional ones in each arm), these cephalopods can solve complex puzzles, open jars, and even use tools. Their remarkable ability to change both color and texture allows them to perfectly mimic their surroundings, making them masters of disguise. Despite their impressive capabilities, most octopus species live only 1-2 years, making their intelligence even more remarkable given their short lifespan.</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="st">'id'</span>:<span class="st">'animal_book'</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> splitter(doc):</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    doc_id <span class="op">=</span> doc[<span class="st">'id'</span>]</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> doc[<span class="st">'text'</span>]</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{<span class="st">'text'</span>:chunk.strip(),<span class="st">'id'</span>:<span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>} <span class="cf">for</span> i,chunk <span class="kw">in</span> <span class="bu">enumerate</span>(text.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>))]</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarizer(text):</span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> text[:<span class="dv">20</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-154" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Distilation Rag Uploader'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'split_texts'</span>,splitter,inputs<span class="op">=</span>[<span class="st">'Start(doc=.)'</span>],for_each<span class="op">=</span>[<span class="st">'doc'</span>],flat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'summarize_texts'</span>,summarizer,inputs<span class="op">=</span>[<span class="st">'split_texts(text=text)'</span>],for_each<span class="op">=</span>[<span class="st">'text'</span>])</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'summarize_texts'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-155" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run([sample_doc]):</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trace.pprint()</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="st">'The arctic fox is a '</span>, <span class="st">'The elephant is one '</span>, <span class="st">'The octopus stands o'</span>],d.output</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>
<div id="cell-157" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for trace in d.run({'pdfs':['path/to/pdf.pdf','path/to/pdf2.pdf']}):</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     # </span><span class="al">TODO</span><span class="co"> make pprint to log</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     # make progress bars for parallel pipelines with multiple items</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         # see this https://stackoverflow.com/a/78127892</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     trace.to_logger()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/DeanLight\.github\.io\/StringDALE");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/DeanLight/StringDALE/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>