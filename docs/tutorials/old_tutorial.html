<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.9.13">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Tutorial – StringDALE</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ac077c1e730dfeb5e42400639d17284e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-000f0825b9c55ed21d14970d810c14a9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Tutorial – StringDALE">
<meta property="og:description" content="String Diagram Agent Language Express (StringDALE) is a language for building LLM agents using string diagrams.">
<meta property="og:image" content="https://DeanLight.github.io/StringDALE/docs/tutorials/090_old_tutorial_files/figure-html/cell-3-output-1.svg">
<meta property="og:site_name" content="StringDALE">
<meta name="twitter:title" content="Tutorial – StringDALE">
<meta name="twitter:description" content="String Diagram Agent Language Express (StringDALE) is a language for building LLM agents using string diagrams.">
<meta name="twitter:image" content="https://DeanLight.github.io/StringDALE/docs/tutorials/090_old_tutorial_files/figure-html/cell-3-output-1.svg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">StringDALE</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../index.html" aria-current="page"> 
<span class="menu-text">Getting Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../docs/tutorials/getting_started.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../docs/examples/001_rag.html"> 
<span class="menu-text">Examples</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../docs/reference/diagrams.html"> 
<span class="menu-text">Reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/DeanLight/stringdale"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Tutorial</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello world</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/port_mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Port Mapping</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/decision_diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decision Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/nested_diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nested Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/compound_diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Compound Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/customizing_state.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Customizing State</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/stateful_nodes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stateful Nodes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/batching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Batching</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/keeping_diagrams_dry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Keeping Diagrams DRY</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/tutorials/evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Examples</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/examples/001_rag.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RAG</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/examples/002_react.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">React</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/examples/003_interactive_qa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactive QA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/examples/rag_on_summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RAG on summary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/examples/interactive_qa_db.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactive QA with DB</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/examples/monitor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Monitor Pattern</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/examples/router.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Routing Pattern</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Reference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/reference/diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/reference/chat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/reference/dbs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DBs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/reference/tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tools</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../docs/reference/eval.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Eval</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#imports" id="toc-imports" class="nav-link active" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#basic-flow-diagram" id="toc-basic-flow-diagram" class="nav-link" data-scroll-target="#basic-flow-diagram">Basic flow diagram</a>
  <ul class="collapse">
  <li><a href="#defining-a-diagram" id="toc-defining-a-diagram" class="nav-link" data-scroll-target="#defining-a-diagram">Defining a diagram</a></li>
  <li><a href="#running-a-diagram" id="toc-running-a-diagram" class="nav-link" data-scroll-target="#running-a-diagram">Running a diagram</a></li>
  </ul></li>
  <li><a href="#basic-ports" id="toc-basic-ports" class="nav-link" data-scroll-target="#basic-ports">Basic ports</a></li>
  <li><a href="#flow-diagram-with-a-function-node" id="toc-flow-diagram-with-a-function-node" class="nav-link" data-scroll-target="#flow-diagram-with-a-function-node">Flow diagram with a function node</a></li>
  <li><a href="#flow-diagram-with-a-diagram-node" id="toc-flow-diagram-with-a-diagram-node" class="nav-link" data-scroll-target="#flow-diagram-with-a-diagram-node">Flow diagram with a diagram node</a></li>
  <li><a href="#flow-diagram-with-async-functions" id="toc-flow-diagram-with-async-functions" class="nav-link" data-scroll-target="#flow-diagram-with-async-functions">Flow diagram with async functions</a></li>
  <li><a href="#ports---more" id="toc-ports---more" class="nav-link" data-scroll-target="#ports---more">Ports - more</a>
  <ul class="collapse">
  <li><a href="#double-splat" id="toc-double-splat" class="nav-link" data-scroll-target="#double-splat">Double splat (**)</a></li>
  <li><a href="#unnamed-ports-for-discarding-inputs" id="toc-unnamed-ports-for-discarding-inputs" class="nav-link" data-scroll-target="#unnamed-ports-for-discarding-inputs">Unnamed ports for discarding inputs</a></li>
  </ul></li>
  <li><a href="#decision-diagrams" id="toc-decision-diagrams" class="nav-link" data-scroll-target="#decision-diagrams">Decision diagrams</a></li>
  <li><a href="#breaks" id="toc-breaks" class="nav-link" data-scroll-target="#breaks">Breaks</a>
  <ul class="collapse">
  <li><a href="#nested-breaks" id="toc-nested-breaks" class="nav-link" data-scroll-target="#nested-breaks">Nested breaks</a></li>
  </ul></li>
  <li><a href="#states" id="toc-states" class="nav-link" data-scroll-target="#states">States</a>
  <ul class="collapse">
  <li><a href="#default-states" id="toc-default-states" class="nav-link" data-scroll-target="#default-states">Default states</a></li>
  <li><a href="#custom-states" id="toc-custom-states" class="nav-link" data-scroll-target="#custom-states">Custom states</a></li>
  </ul></li>
  <li><a href="#combination-of-flow-and-decision-diagrams" id="toc-combination-of-flow-and-decision-diagrams" class="nav-link" data-scroll-target="#combination-of-flow-and-decision-diagrams">Combination of Flow and Decision Diagrams</a></li>
  <li><a href="#batching" id="toc-batching" class="nav-link" data-scroll-target="#batching">Batching</a>
  <ul class="collapse">
  <li><a href="#basic-batch-processing" id="toc-basic-batch-processing" class="nav-link" data-scroll-target="#basic-batch-processing">Basic Batch Processing</a></li>
  <li><a href="#cartesian-products" id="toc-cartesian-products" class="nav-link" data-scroll-target="#cartesian-products">Cartesian Products</a></li>
  <li><a href="#mixing-stream-and-non-stream-inputs" id="toc-mixing-stream-and-non-stream-inputs" class="nav-link" data-scroll-target="#mixing-stream-and-non-stream-inputs">Mixing Stream and Non-Stream Inputs</a></li>
  <li><a href="#nested-diagrams-in-batch-processing" id="toc-nested-diagrams-in-batch-processing" class="nav-link" data-scroll-target="#nested-diagrams-in-batch-processing">Nested Diagrams in Batch Processing</a></li>
  <li><a href="#real-world-example-text-processing" id="toc-real-world-example-text-processing" class="nav-link" data-scroll-target="#real-world-example-text-processing">Real-World Example: Text Processing</a></li>
  </ul></li>
  <li><a href="#stateful-nodes-and-serialization" id="toc-stateful-nodes-and-serialization" class="nav-link" data-scroll-target="#stateful-nodes-and-serialization">Stateful nodes and Serialization</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/DeanLight/StringDALE/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tutorial</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="imports" class="level1">
<h1>Imports</h1>
<div id="cell-3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale.diagrams <span class="im">import</span> (</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    Define,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    Scope,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    V,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    E,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    draw_diagram</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale.core <span class="im">import</span>  checkLogs</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale.viz <span class="im">import</span> draw_nx</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="basic-flow-diagram" class="level1">
<h1>Basic flow diagram</h1>
<p>Diagrams consist of nodes and edges.</p>
<p>Nodes are defined using the V function.</p>
<p>Edges are defined using the E function.</p>
<p>We can define a diagram using nodes or edges.</p>
<p>The simplest diagram is a flow diagram. It consists of nodes and parallel edges: edges that are used to run multiple nodes in parallel.</p>
<p>There are 3 reserved node names: * State: a node that is used to store and access state between node executions (see states section) * Start: the start of the diagram * End: the end of the diagram</p>
<section id="defining-a-diagram" class="level2">
<h2 class="anchored" data-anchor-id="defining-a-diagram">Defining a diagram</h2>
<p>Let’s define the simplest flow diagram using V - it doesn’t do actions just runs nodes in parallel.</p>
<div id="cell-6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'basic_flow1'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'transfer'</span>,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-3-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can define the same diagram using E.</p>
<div id="cell-8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'basic_flow2'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;transfer'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'transfer-&gt;End'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-4-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can also print out a diagram without rendering it</p>
<div id="cell-10" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>draw_diagram(D)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-5-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="running-a-diagram" class="level2">
<h2 class="anchored" data-anchor-id="running-a-diagram">Running a diagram</h2>
<p>We create an instance of diagram D to make sure we get a fresh copy of the diagram in cases where we want have multiple instances of the same diagram.</p>
<div id="cell-13" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Run the diagram</p>
<div id="cell-15" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Can run the whole diagram fom beginning to the end</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Run the whole diagram fom beginning to the end:'</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(d.run_all(<span class="dv">0</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We can check if diagram got to the end    </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Check if diagram got to the end:'</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(d.finished)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># We can check the output of the diagram</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Check the output of the diagram:'</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(d.output)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Run the whole diagram fom beginning to the end:
0
Check if diagram got to the end:
True
Check the output of the diagram:
0</code></pre>
</div>
</div>
<p>Usually we would want to run the diagram step by step to see what’s happening.</p>
<p>For that we use d.run() and print the trace every node that is run will return a trace object.</p>
<p>This trace object contains the input and output of the node as well as some other useful information we can use this trace to both debug the diagram.</p>
<p>We can print the trace to the user.</p>
<div id="cell-17" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Run the diagram step by step to see what</span><span class="ch">\'</span><span class="st">s happening:'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Run the diagram step by step to see what's happening:
Node Start:
{'input': {0: 0}, 'output': 0}
================================================================================
Node transfer:
{'input': {0: 0}, 'output': 0}
================================================================================
Node End:
{'input': {0: 0}, 'output': 0}
================================================================================</code></pre>
</div>
</div>
<p>Or we can save the trace to a file (logging)</p>
<div id="cell-19" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>log_file <span class="op">=</span> <span class="st">'log.txt'</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint(<span class="bu">file</span><span class="op">=</span>log_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s take a look at the log file</p>
<div id="cell-21" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> cat log.txt</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>os.unlink(log_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 0}, 'output': 0}
================================================================================
Node transfer:
{'input': {0: 0}, 'output': 0}
================================================================================
Node End:
{'input': {0: 0}, 'output': 0}
================================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="basic-ports" class="level1">
<h1>Basic ports</h1>
<p>Till now we have been using the default ports.</p>
<p>But we can also define custom ports for a node.</p>
<p>Note that the output_port of the Start node is passed to the input_port of the End node.</p>
<p>And the other port is discarded.</p>
<div id="cell-24" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'ports'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;transfer(input1_port=output_port)'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'transfer-&gt;End'</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'output_port'</span>:<span class="dv">1</span>,<span class="st">'other_port'</span>:<span class="dv">2</span>}):</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-11-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{ 'input': {'other_port': 2, 'output_port': 1},
  'output': {'other_port': 2, 'output_port': 1}}
================================================================================
Node transfer:
{'input': {'input1_port': 1}, 'output': {'input1_port': 1}}
================================================================================
Node End:
{'input': {0: {'input1_port': 1}}, 'output': {'input1_port': 1}}
================================================================================</code></pre>
</div>
</div>
<p>We can also use the . notation to get the output of the previous node as one variable.</p>
<div id="cell-26" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'ports'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;transfer(input1_port=output_port)'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'transfer-&gt;End(result =.)'</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'output_port'</span>:<span class="dv">1</span>,<span class="st">'other_port'</span>:<span class="dv">2</span>}):</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># note that the output_port of the Start node is passed to the input_port of the End node</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the other port is discarded</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-12-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{ 'input': {'other_port': 2, 'output_port': 1},
  'output': {'other_port': 2, 'output_port': 1}}
================================================================================
Node transfer:
{'input': {'input1_port': 1}, 'output': {'input1_port': 1}}
================================================================================
Node End:
{ 'input': {'result': {'input1_port': 1}},
  'output': {'result': {'input1_port': 1}}}
================================================================================</code></pre>
</div>
</div>
<p>We can also use several ports to define multiple edges from the same node.</p>
<div id="cell-28" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'ports'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;transfer(x=a, y=b)'</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we use . to get all ports</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'transfer-&gt;End(e1 = x, e2 = y)'</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'a'</span>:<span class="dv">1</span>,<span class="st">'b'</span>:<span class="dv">2</span>}):</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-13-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {'a': 1, 'b': 2}, 'output': {'a': 1, 'b': 2}}
================================================================================
Node transfer:
{'input': {'x': 1, 'y': 2}, 'output': {'x': 1, 'y': 2}}
================================================================================
Node End:
{'input': {'e1': 1, 'e2': 2}, 'output': {'e1': 1, 'e2': 2}}
================================================================================</code></pre>
</div>
</div>
<p>See the difference when we don’t define the ports for the End node.</p>
<div id="cell-30" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'ports'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;transfer(x=a, y=b)'</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'transfer-&gt;End'</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'a'</span>:<span class="dv">1</span>,<span class="st">'b'</span>:<span class="dv">2</span>}):</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-14-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {'a': 1, 'b': 2}, 'output': {'a': 1, 'b': 2}}
================================================================================
Node transfer:
{'input': {'x': 1, 'y': 2}, 'output': {'x': 1, 'y': 2}}
================================================================================
Node End:
{'input': {0: {'x': 1, 'y': 2}}, 'output': {'x': 1, 'y': 2}}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="flow-diagram-with-a-function-node" class="level1">
<h1>Flow diagram with a function node</h1>
<p>A node can have a function and perform some operations.</p>
<div id="cell-33" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus2(x):</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'parallel_flow'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> ParallelD:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x1 = . is a way to pass the output of the node to the x1 port End node</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'parallel_1'</span>,plus1,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End(x1 = .)'</span>])</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'parallel_2'</span>,plus2,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End(x2 = .)'</span>])</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> ParallelD()</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-15-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 0}, 'output': 0}
================================================================================
Node parallel_2:
{'input': {0: 0}, 'output': 2}
================================================================================
Node parallel_1:
{'input': {0: 0}, 'output': 1}
================================================================================
Node End:
{'input': {'x1': 1, 'x2': 2}, 'output': {'x1': 1, 'x2': 2}}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="flow-diagram-with-a-diagram-node" class="level1">
<h1>Flow diagram with a diagram node</h1>
<p>We can use an existing diagram as a node. parallel_adder is a node that uses the ParallelD diagram we defined earlier.</p>
<p>See that trace has all the nodes from the ParallelD diagram (parallel_adder.Start, parallel_adder.parallel_1 etc)</p>
<div id="cell-36" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'constructed_flow'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'parallel_adder'</span>,ParallelD,inputs<span class="op">=</span>[<span class="st">'Start'</span>],outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-16-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 0}, 'output': 0}
================================================================================
Node parallel_adder.Start:
{'input': {0: 0}, 'output': 0}
================================================================================
Node parallel_adder.parallel_2:
{'input': {0: 0}, 'output': 2}
================================================================================
Node parallel_adder.parallel_1:
{'input': {0: 0}, 'output': 1}
================================================================================
Node parallel_adder.End:
{'input': {'x1': 1, 'x2': 2}, 'output': {'x1': 1, 'x2': 2}}
================================================================================
Node parallel_adder:
{'input': {0: 0}, 'output': {'x1': 1, 'x2': 2}}
================================================================================
Node End:
{'input': {0: {'x1': 1, 'x2': 2}}, 'output': {'x1': 1, 'x2': 2}}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="flow-diagram-with-async-functions" class="level1">
<h1>Flow diagram with async functions</h1>
<p>We can use async functions in a flow diagram.</p>
<div id="cell-39" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> plus1async(x,<span class="op">**</span>kwargs):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="fl">0.1</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='__main__'):</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'test'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus1async)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add2'</span>,plus1async)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,outputs<span class="op">=</span>[<span class="st">'add1'</span>,<span class="st">'add2'</span>])</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'prep_end'</span>,inputs<span class="op">=</span>[<span class="st">'add1(x)'</span>,<span class="st">'add2(y)'</span>])</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'prep_end-&gt;End'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-17-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-40" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> {<span class="st">'x'</span>: <span class="dv">2</span>, <span class="st">'y'</span>: <span class="dv">2</span>}</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 1}, 'output': 1}
================================================================================
Node add2:
{'input': {0: 1}, 'output': 2}
================================================================================
Node add1:
{'input': {0: 1}, 'output': 2}
================================================================================
Node prep_end:
{'input': {'x': 2, 'y': 2}, 'output': {'x': 2, 'y': 2}}
================================================================================
Node End:
{'input': {0: {'x': 2, 'y': 2}}, 'output': {'x': 2, 'y': 2}}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="ports---more" class="level1">
<h1>Ports - more</h1>
<section id="double-splat" class="level2">
<h2 class="anchored" data-anchor-id="double-splat">Double splat (**)</h2>
<p>** is used to “expand” a dict into keyword arguments.</p>
<p>Sum node expects two arguments x and y. We unpack the output of the Parallel_end node into keyword arguments.</p>
<div id="cell-43" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus2(y):</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y<span class="op">+</span><span class="dv">2</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum2(x,y):</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'parallel_flow_splat'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> ParallelDS:</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'Parallel_node1(x=x)'</span>,<span class="st">'Parallel_node2(y=y)'</span>]</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node1'</span>,plus1)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node2'</span>,plus2)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node1-&gt;Parallel_end(x=.)'</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node2-&gt;Parallel_end(y=.)'</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Sum'</span>,sum2)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_end-&gt;Sum(**)'</span>) </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Sum-&gt;End'</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> ParallelDS()</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'x'</span>:<span class="dv">1</span>,<span class="st">'y'</span>:<span class="dv">2</span>}):</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-19-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {'x': 1, 'y': 2}, 'output': {'x': 1, 'y': 2}}
================================================================================
Node Parallel_node2:
{'input': {'y': 2}, 'output': 4}
================================================================================
Node Parallel_node1:
{'input': {'x': 1}, 'output': 2}
================================================================================
Node Parallel_end:
{'input': {'x': 2, 'y': 4}, 'output': {'x': 2, 'y': 4}}
================================================================================
Node Sum:
{'input': {'x': 2, 'y': 4}, 'output': 6}
================================================================================
Node End:
{'input': {0: 6}, 'output': 6}
================================================================================</code></pre>
</div>
</div>
<p>If we don’t use double splat, the output of parallel end is passed as one argument to the Sum node.</p>
<p>We get an error because the sum function expects two arguments.</p>
<div id="cell-45" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'parallel_flow'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> ParallelD:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'Parallel_node1(x=x)'</span>,<span class="st">'Parallel_node2(y=y)'</span>]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node1'</span>,plus1)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node2'</span>,plus2)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node1-&gt;Parallel_end(x=.)'</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node2-&gt;Parallel_end(y=.)'</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Sum'</span>,<span class="bu">sum</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_end-&gt;Sum'</span>) </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Sum-&gt;End'</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> ParallelD()</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'x'</span>:<span class="dv">1</span>,<span class="st">'y'</span>:<span class="dv">2</span>}):</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        trace.pprint()</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-20-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {'x': 1, 'y': 2}, 'output': {'x': 1, 'y': 2}}
================================================================================
Node Parallel_node1:
{'input': {'x': 1}, 'output': 2}
================================================================================
Node Parallel_node2:
{'input': {'y': 2}, 'output': 4}
================================================================================
Node Parallel_end:
{'input': {'x': 2, 'y': 4}, 'output': {'x': 2, 'y': 4}}
================================================================================
Error: When running node 'Sum[None]':
Function &lt;built-in function sum&gt;(args=[{'x': 2, 'y': 4}],kwargs={})
returned
Error 'unsupported operand type(s) for +: 'int' and 'str''
</code></pre>
</div>
</div>
<p>We can always explicitly pass the arguments to the Sum node.</p>
<p>But double splat is more convenient when there are many arguments.</p>
<div id="cell-47" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'parallel_flow_explicit'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> ParallelE:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'Parallel_node1(x=x)'</span>,<span class="st">'Parallel_node2(y=y)'</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node1'</span>,plus1)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node2'</span>,plus2)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node1-&gt;Parallel_end(x=.)'</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node2-&gt;Parallel_end(y=.)'</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Sum'</span>,sum2)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_end-&gt;Sum(x=x,y=y)'</span>) </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Sum-&gt;End'</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> ParallelE()</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>d.run_all({<span class="st">'x'</span>: <span class="dv">1</span>,<span class="st">'y'</span>:<span class="dv">2</span>})</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="st">'finished:'</span>, d.finished)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="st">'output:'</span>,d.output)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-21-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>finished: True
output: 6</code></pre>
</div>
</div>
</section>
<section id="unnamed-ports-for-discarding-inputs" class="level2">
<h2 class="anchored" data-anchor-id="unnamed-ports-for-discarding-inputs">Unnamed ports for discarding inputs</h2>
<p>We can discard inputs that we don’t need in the next node.</p>
<div id="cell-49" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'unnamed_ports'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;Transfer(y=y)'</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'plus'</span>,plus1,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Start(_=x)'</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Transfer(x=y)'</span>],</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-22-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-50" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):    </span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'x'</span>:<span class="dv">1</span>,<span class="st">'y'</span>:<span class="dv">2</span>}):</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {'x': 1, 'y': 2}, 'output': {'x': 1, 'y': 2}}
================================================================================
Node Transfer:
{'input': {'y': 2}, 'output': {'y': 2}}
================================================================================
Node plus:
{'input': {'x': 2}, 'output': 3}
================================================================================
Node End:
{'input': {0: 3}, 'output': 3}
================================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="decision-diagrams" class="level1">
<h1>Decision diagrams</h1>
<p>Decision diagrams allow you to create conditional flows in your graph where execution can take different paths based on conditions. Here are the key concepts:</p>
<ol type="1">
<li><p><strong>Conditional Edges</strong>: Edges can have conditions attached to them using the <code>cond</code> parameter. When a condition is specified, the edge will only be followed if the condition evaluates to <code>True</code>.</p></li>
<li><p><strong>Default Edges</strong>: Any edge without a condition acts as a default path. When no conditional edges evaluate to <code>True</code>, the flow follows the default edge.</p></li>
<li><p><strong>Rules</strong>:</p>
<ul>
<li>Each node that has outgoing conditional edges must have at least one default edge</li>
<li>All conditions on outgoing edges are evaluated in parallel</li>
<li>If more than one condition evaluates to <code>True</code>, an error is raised</li>
<li>For a given node, all incoming non-state edges must be of the same type (either all conditional or all non-conditional)</li>
<li>Similarly, all outgoing edges must be of the same type (either all conditional or all non-conditional)</li>
</ul></li>
</ol>
<p>Here’s a simple example:</p>
<div id="cell-53" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mod2(x):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">%</span><span class="dv">2</span><span class="op">==</span><span class="dv">0</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'decision_diagram'</span>) <span class="im">as</span> DecisionD:</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Conditional_node'</span>,plus1)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;Conditional_node'</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Option1'</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Default_option'</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># by default, all edges we define are conditional,</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can specify a condition for an edge by passing a function to the cond argument</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Conditional_node-&gt;Option1'</span>,cond<span class="op">=</span>mod2)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># not passing a condition means that this edge is the default edge</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># each node that has outgoing conditional edges must have at least one default edge</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Conditional_node-&gt;Default_option'</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Option1-&gt;End'</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Default_option-&gt;End'</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> DecisionD()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-24-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This should go to Option1 node</p>
<div id="cell-55" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 1}, 'output': 1}
================================================================================
Node Conditional_node:
{'input': {0: 1}, 'output': 2}
================================================================================
Node Option1:
{'input': {0: 2}, 'output': 2}
================================================================================
Node End:
{'input': {0: 2}, 'output': 2}
================================================================================</code></pre>
</div>
</div>
<p>This should go to Default_option node</p>
<div id="cell-57" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 0}, 'output': 0}
================================================================================
Node Conditional_node:
{'input': {0: 0}, 'output': 1}
================================================================================
Node Default_option:
{'input': {0: 1}, 'output': 1}
================================================================================
Node End:
{'input': {0: 1}, 'output': 1}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="breaks" class="level1">
<h1>Breaks</h1>
<p>Breaks are a feature in stringdale that allow you to pause diagram execution and get new input from the user before continuing. Their main purpose is to create interactive flows where you can get user input at specific points in the execution.</p>
<ul>
<li><p>When execution reaches a break node, the diagram pauses and waits for new input.</p></li>
<li><p>After receiving new input, execution continues from the break point.</p></li>
<li><p>Breaks can be combined with conditional edges to create complex interactive flows</p></li>
</ul>
<div id="cell-59" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LLM dummy function</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MessageAdder():</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,to_add):</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.to_add <span class="op">=</span> to_add</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,<span class="op">**</span>message):</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> message.get(<span class="st">'content'</span>,<span class="dv">0</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(content,<span class="bu">int</span>):</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>            new_cont <span class="op">=</span> content <span class="op">+</span> <span class="va">self</span>.to_add</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(content,<span class="bu">str</span>):</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>            new_cont <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>content<span class="sc">}</span><span class="ss"> _ '</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f'content </span><span class="sc">{</span>content<span class="sc">}</span><span class="ss"> must be an int or a string'</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">'role'</span>:<span class="st">'adder'</span>,<span class="st">'content'</span>:new_cont}</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MessageAdder(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>to_add<span class="sc">}</span><span class="ss">)'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>In this simple example a break happens only once per run if the condition is met.</p>
<div id="cell-61" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'decision with break'</span>) <span class="im">as</span> D:</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus2 ,inputs<span class="op">=</span>[<span class="st">'Start'</span>],)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add1-&gt;break'</span>,cond<span class="op">=</span>is112)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add1-&gt;End'</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'break-&gt;End'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-28-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-62" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Run with input 100. The break is not met, so the diagram continues to the End node.</p>
<div id="cell-64" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Running with input 100:"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>d.run_all(<span class="dv">100</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"d.finished: </span><span class="sc">{</span>d<span class="sc">.</span>finished<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running with input 100:
d.finished: True</code></pre>
</div>
</div>
<p>Run with input 110. The break is met, so the diagram pauses and waits for new input.</p>
<div id="cell-66" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Running with input 110:"</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">110</span>):</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"d.finished: </span><span class="sc">{</span>d<span class="sc">.</span>finished<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running with input 110:
Node Start:
{'input': {0: 110}, 'output': 110}
================================================================================
Node add1:
{'input': {0: 110}, 'output': 112}
================================================================================
d.finished: False</code></pre>
</div>
</div>
<p>If run the diagram again, we see that it starts from the break node and continues to the End node.</p>
<div id="cell-68" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">112</span>):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"d.finished: </span><span class="sc">{</span>d<span class="sc">.</span>finished<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node break:
{'input': {0: 112}, 'output': 112}
================================================================================
Node End:
{'input': {0: 112}, 'output': 112}
================================================================================
d.finished: True</code></pre>
</div>
</div>
<p>In this example we define a loop with a break condition. The diagram will continue looping and asking for the user input until the result of the add1 node equals 112, at which point it will exit the loop and proceed to the End node.</p>
<div id="cell-70" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'decision with break loop'</span>) <span class="im">as</span> D:</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus2,inputs<span class="op">=</span>[<span class="st">'Start'</span>],)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add1-&gt;End'</span>,cond<span class="op">=</span>is112)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add1-&gt;break'</span>)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'break-&gt;add1'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-33-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It’s a slightly different example. The condition is met when the input equals 112.</p>
<div id="cell-72" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'decision with break'</span>) <span class="im">as</span> D:</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus2,inputs<span class="op">=</span>[<span class="st">'Start'</span>],)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add1-&gt;break'</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'break-&gt;add1'</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'break-&gt;End'</span>,cond<span class="op">=</span>is112)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-34-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-73" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with input 100</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Running with input 100:"</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>d.run_all(<span class="dv">100</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># After running with 100, we haven't reached the end condition (x == 112)</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># so the diagram is not finished</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished <span class="op">==</span> <span class="va">False</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Finished: </span><span class="sc">{</span>d<span class="sc">.</span>finished<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with input 101</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Running with input 101:"</span>)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>d.run_all(<span class="dv">101</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Still haven't reached the end condition</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.finished <span class="op">==</span> <span class="va">False</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Finished: </span><span class="sc">{</span>d<span class="sc">.</span>finished<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with input 110</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Running with input 110:"</span>)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>d.run_all(<span class="dv">112</span>)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="co"># After adding 2 to 110, we get 112, which satisfies our end condition</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Finished: </span><span class="sc">{</span>d<span class="sc">.</span>finished<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running with input 100:
Finished: False

Running with input 101:
Finished: False

Running with input 110:
Finished: True</code></pre>
</div>
</div>
<section id="nested-breaks" class="level2">
<h2 class="anchored" data-anchor-id="nested-breaks">Nested breaks</h2>
<div id="cell-75" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_3(x):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">3</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_10(x):</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">10</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'inner_break'</span>) <span class="im">as</span> InnerD:</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">0</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'break'</span>])</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,outputs<span class="op">=</span>[<span class="st">'add(**)'</span>,(<span class="st">'End'</span>,is_3)])</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'outer_break'</span>) <span class="im">as</span> OuterD:</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'inner'</span>,InnerD,inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'break'</span>])</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,outputs<span class="op">=</span>[<span class="st">'inner(**)'</span>,(<span class="st">'End'</span>,is_10)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-36-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-36-output-2.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Expected Behavior:</strong> * We enter the inner diagram and remain there until we receive a message with content=3 * When we receive a 3, we exit the inner diagram and hit the break in the outer diagram * The outer diagram will only terminate when we receive a message with content=10 * To completely exit both diagrams, we need a sequence where: * First a message with content=3 (to exit the inner diagram) * Then a message with content=10 (to exit the outer diagram)</p>
<div id="cell-77" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> [</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">0</span>},</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">1</span>},</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">2</span>},</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">3</span>}, <span class="co"># exit inner the first time</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">5</span>}, <span class="co"># go to outer and then to inner again</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">10</span>}, <span class="co"># 10 wont get us out of the inner diagram</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">3</span>}, <span class="co"># exit inner the second time</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'role'</span>:<span class="st">'human'</span>,<span class="st">'content'</span>:<span class="dv">10</span>}, <span class="co"># 10 will get us out of the outer diagram</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>outer_d <span class="op">=</span> OuterD()</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> outer_d.run(<span class="bu">input</span><span class="op">=</span>inputs.pop(<span class="dv">0</span>)):</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(f'{trace.node_name[0]:&lt;16} == {trace.input_}')</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>) <span class="co"># we use passthrough=True to skip the nodes that only pass the information through and dont' change it</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> outer_d.finished:</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> outer_d.output <span class="op">==</span> {<span class="st">'role'</span>: <span class="st">'human'</span>, <span class="st">'content'</span>: <span class="dv">10</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node inner.add:
{ 'input': {'content': 0, 'role': 'human'},
  'output': {'content': 0, 'role': 'adder'}}
================================================================================
Node inner:
{ 'input': {'content': 0, 'role': 'human'},
  'output': {'content': 0, 'role': 'adder'}}
================================================================================
Node inner.add:
{ 'input': {'content': 1, 'role': 'human'},
  'output': {'content': 1, 'role': 'adder'}}
================================================================================
Node inner:
{ 'input': {'content': 1, 'role': 'human'},
  'output': {'content': 1, 'role': 'adder'}}
================================================================================
Node inner.add:
{ 'input': {'content': 2, 'role': 'human'},
  'output': {'content': 2, 'role': 'adder'}}
================================================================================
Node inner:
{ 'input': {'content': 2, 'role': 'human'},
  'output': {'content': 2, 'role': 'adder'}}
================================================================================
Node inner:
{ 'input': {'content': 3, 'role': 'human'},
  'output': {'content': 3, 'role': 'human'}}
================================================================================
Node inner.add:
{ 'input': {'content': 5, 'role': 'human'},
  'output': {'content': 5, 'role': 'adder'}}
================================================================================
Node inner:
{ 'input': {'content': 5, 'role': 'human'},
  'output': {'content': 5, 'role': 'adder'}}
================================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="states" class="level1">
<h1>States</h1>
<ul>
<li>States are used to save and return a variable, we can use them to pass data between nodes without creating direct connections in your flow.</li>
<li>An edge from the State node to another node, used for either setting or getting part of the state is called a state edge.</li>
</ul>
<section id="default-states" class="level2">
<h2 class="anchored" data-anchor-id="default-states">Default states</h2>
<p>Key points about default states:</p>
<ul>
<li><p><strong>Writing to state</strong>:<br>
Use <code>E('node-&gt;state/key')</code> to save a node’s output to state with key <code>key</code>.</p></li>
<li><p><strong>Reading from state</strong>: Use <code>E('state/key-&gt;node(port=.)')</code> to read from state.</p></li>
<li><p><strong>No special setup needed</strong>: Default states work out of the box without any configuration.</p></li>
<li><p><strong>Values persist throughout diagram execution</strong>: Each diagram instance maintains its own separate state.</p></li>
</ul>
<div id="cell-80" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus2(x):</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">2</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.validate'):</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'states'</span>) <span class="im">as</span> StateD:</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Option1'</span>,plus2)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Default_option'</span>,plus1)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;Option1'</span>,cond<span class="op">=</span>mod2)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;Default_option'</span>)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Default_option-&gt;End'</span>)</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Option1-&gt;End'</span>)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;state/start'</span>)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'state/start-&gt;End(start_state=.)'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-38-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-81" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> StateD()</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Running with input 1:'</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">1</span>):</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Running with input 2:'</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">2</span>):</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running with input 1:
Node Start:
{'input': {0: 1}, 'output': 1}
================================================================================
Node Default_option:
{'input': {0: 1}, 'output': 2}
================================================================================
Node End:
{'input': {0: 2, 'start_state': 1}, 'output': {0: 2, 'start_state': 1}}
================================================================================
Running with input 2:
Node Start:
{'input': {0: 2}, 'output': 2}
================================================================================
Node Option1:
{'input': {0: 2}, 'output': 4}
================================================================================
Node End:
{'input': {0: 4, 'start_state': 2}, 'output': {0: 4, 'start_state': 2}}
================================================================================</code></pre>
</div>
</div>
<p>If we don’t pass the state input from another node we need to initialize it on run</p>
<div id="cell-83" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'init_state_no_clash'</span>) <span class="im">as</span> NoClash:</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,plus,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'Start(x)'</span>,<span class="st">'State/init(y)'</span>],</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'State/first_sum'</span>]</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'break'</span>,is_break<span class="op">=</span><span class="va">True</span>,inputs<span class="op">=</span>[<span class="st">'add1(x)'</span>])</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add2'</span>,plus,</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'break(x)'</span>,<span class="st">'State/first_sum(y)'</span>],</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>]</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-40-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>If we don’t initialize the state on run, we get an error.</p>
<div id="cell-85" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> NoClash()</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        trace.pprint()</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">AttributeError</span> <span class="im">as</span> e:</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 10}, 'output': 10}
================================================================================
Error: When getting state key 'init' from state BaseModelExtra():

Original error: 'BaseModelExtra' object has no attribute 'init'</code></pre>
</div>
</div>
<div id="cell-86" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> [</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> []</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>NoClash()</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># note that here the init state is preserved between runs</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="bu">input</span><span class="op">=</span>inputs.pop(<span class="dv">0</span>),state<span class="op">=</span>{<span class="st">'init'</span>:<span class="dv">1000</span>}):</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>        trace.pprint()</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    outputs.append(d.output)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> d.finished:</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> outputs <span class="op">==</span> [<span class="dv">1010</span>,<span class="dv">1110</span>],outputs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 10}, 'output': 10}
================================================================================
Node add1:
{'input': {'x': 10, 'y': 1000}, 'output': 1010}
================================================================================
Node break:
{'input': {0: 100}, 'output': 100}
================================================================================
Node add2:
{'input': {'x': 100, 'y': 1010}, 'output': 1110}
================================================================================
Node End:
{'input': {0: 1110}, 'output': 1110}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="custom-states" class="level2">
<h2 class="anchored" data-anchor-id="custom-states">Custom states</h2>
<p>Custom states provide a way to implement more sophisticated state management behavior in your diagrams. They are implemented using Pydantic BaseModel classes.</p>
<p>Let’s see an example of a history of values custom state.</p>
<div id="cell-88" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> stringdale.core <span class="im">import</span> NamedLambda</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel,ConfigDict,computed_field</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus1(x):</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># a custom state is any basemodel</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomState(BaseModel):</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can allow arbitrary attributes by setting extra='allow'</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this is useful for defining on the fly state keys with normal behavior</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    model_config <span class="op">=</span> ConfigDict(extra<span class="op">=</span><span class="st">'allow'</span>)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define typed fields with default values</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    history:<span class="bu">list</span>[<span class="bu">int</span>] <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Custom methods to manipulate state</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(<span class="va">self</span>,value):</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history.append(value)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>State Operations: * Read from state using State/key-&gt;node(port=.) * Write to state using node-&gt;State/key * Custom operations through defined methods like save()</p>
<div id="cell-90" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'save_state'</span>,state<span class="op">=</span>CustomState) <span class="im">as</span> D:</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,plus1)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add'</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add-&gt;End'</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add-&gt;State/save'</span>) </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> - not sure what those mean and where to put them</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co"># we can customize the state behaviour of a given state key by using the State function</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set_append=True means that the state value will be appended to the list of values for the given key</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="co"># we can also add custom getters and setters to a state key for more complex state behaviour</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="co"># getter is a function of the form (value)-&gt;(processed_value)</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co"># setter is a function of the form (old_value,new_value)-&gt;(processed_value)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-44-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here is another example of a custom state. Several nodes writing to State/history to maintain a record of values.</p>
<div id="cell-92" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> pairwise</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any,Annotated</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomState(BaseModel):</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    model_config <span class="op">=</span> ConfigDict(extra<span class="op">=</span><span class="st">'allow'</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    history: Annotated[<span class="bu">list</span>[Any],<span class="bu">list</span>.append] <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'far ancestor writing to state'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>,state<span class="op">=</span>CustomState) <span class="im">as</span> D:</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> MessageAdder(<span class="dv">0</span>)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u <span class="kw">in</span> [<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>]:</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        V(u,a)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        E(<span class="ss">f'</span><span class="sc">{</span>u<span class="sc">}</span><span class="ss">-&gt;state/history'</span>)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u,v <span class="kw">in</span> pairwise([<span class="st">'Start'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="st">'End'</span>]):</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>        E(<span class="ss">f'</span><span class="sc">{</span>u<span class="sc">}</span><span class="ss">-&gt;</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">(**)'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-45-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="combination-of-flow-and-decision-diagrams" class="level1">
<h1>Combination of Flow and Decision Diagrams</h1>
<p>stringdale supports combining flow and decision diagrams within a single diagram, allowing you to leverage both parallel processing and conditional branching. However, there are important rules to follow:</p>
<ol type="1">
<li>While you can mix flow and decision parts in the same diagram, you must keep them separated - a node’s incoming edges must be either all conditional or all parallel, never mixed.</li>
<li>The same rule applies to outgoing edges - they must be either all conditional or all parallel.</li>
</ol>
<p>This separation ensures clear and predictable behavior while still allowing you to build sophisticated workflows that combine both paradigms.</p>
<div id="cell-94" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> MessageSum(<span class="op">**</span>kwargs):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">sum</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key,value <span class="kw">in</span> kwargs.items():</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> value[<span class="st">'content'</span>]</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(count,<span class="bu">int</span>):</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span><span class="op">+=</span>count</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'role'</span>:<span class="st">'sum'</span>,<span class="st">'content'</span>:<span class="bu">sum</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can include decision diagrams as nodes in a flow diagram</p>
<div id="cell-96" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add5'</span>,draw<span class="op">=</span><span class="va">False</span>) <span class="im">as</span> Add5:</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">5</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'End(**)'</span>])</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add10'</span>,draw<span class="op">=</span><span class="va">False</span>) <span class="im">as</span> Add10:</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add_first'</span>,Add5)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add_second'</span>,Add5)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;add_first(**)'</span>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add_first-&gt;add_second(**)'</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'add_second-&gt;End(**)'</span>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'add100'</span>,draw<span class="op">=</span><span class="va">False</span>) <span class="im">as</span> Add100:</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,MessageAdder(<span class="dv">100</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>],outputs<span class="op">=</span>[<span class="st">'End(**)'</span>])</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'paralell2'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> Parallel2:</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Start'</span>,MessageAdder(<span class="dv">1</span>))</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add10'</span>,Add10,inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add100'</span>,Add100,inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,MessageSum,inputs<span class="op">=</span>[<span class="st">'add10(y)'</span>,<span class="st">'add100(x)'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-47-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can use Scope to define a flow subdiagram inside a decision diagram (or otherwise) Here the flow sub diagram is defined inside the decision diagram.</p>
<div id="cell-98" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'paralell with choice'</span>) <span class="im">as</span> D:</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is112(x):</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x[<span class="st">'content'</span>] <span class="op">==</span> <span class="dv">112</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add1'</span>,MessageAdder(<span class="dv">1</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> Scope(<span class="st">'flow'</span>):</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add10'</span>,Add10,inputs<span class="op">=</span>[<span class="st">'add1(**)'</span>])</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'add100'</span>,Add100,inputs<span class="op">=</span>[<span class="st">'add1(**)'</span>])</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        V(<span class="st">'sum'</span>,MessageSum,inputs<span class="op">=</span>[<span class="st">'add10(y)'</span>,<span class="st">'add100(x)'</span>])</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'sum-&gt;End'</span>)</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'sum-&gt;add1(**)'</span>,cond<span class="op">=</span>is112)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#EXPLAIN what are legal parallel cut</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-48-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Or we can explicitly define the edge types</p>
<div id="cell-100" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'edge_types'</span>) <span class="im">as</span> EdgeTypes:</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Conditional_node'</span>,plus1)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;Conditional_node'</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Option1'</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Default_option'</span>)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Conditional_node-&gt;Option1'</span>,cond<span class="op">=</span>mod2)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Conditional_node-&gt;Default_option'</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can also define a parallel edge by passing scope='flow' to the E function</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node1'</span>,plus1)</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Parallel_node2'</span>,plus2)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Option1-&gt;Parallel_node1'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Option1-&gt;Parallel_node2'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node1-&gt;Parallel_end(x=.)'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_node2-&gt;Parallel_end(y=.)'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>)</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Parallel_end-&gt;End(**)'</span>)</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Default_option-&gt;End'</span>)</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'Start-&gt;state/start'</span>)</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    E(<span class="st">'state/start-&gt;End(start_state=.)'</span>)</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> EdgeTypes()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-49-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="batching" class="level1">
<h1>Batching</h1>
<ul>
<li>For_each with stream and non stream (what it even means?) - stream is treating each element as a separate input, non stream is treating the whole list as a single input, right?</li>
<li>Nested diagrams in foreach? what’s the meaning? TODO</li>
</ul>
<p>Some functions that we’ll need for the batching examples.</p>
<p>MakeItems is a class that creates a list of items based on a starting value. * num_items: determines how many items to generate * delta: the increment between each item * sleep: adds a delay to simulate processing time * When called with a value x, it returns a list [x, x+delta, x+2<em>delta, …, x+(num_items-1)</em>delta]</p>
<p>MakeItemsAsync is the asynchronous version of the same functionality.</p>
<div id="cell-103" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MakeItems:</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,num_items,delta,sleep):</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_items <span class="op">=</span> num_items</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.delta <span class="op">=</span> delta</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sleep <span class="op">=</span> sleep</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,x):</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="va">self</span>.sleep)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [x<span class="op">+</span>i<span class="op">*</span><span class="va">self</span>.delta <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_items)]</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MakeItems(num_items=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>num_items<span class="sc">}</span><span class="ss">,delta=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>delta<span class="sc">}</span><span class="ss">,sleep=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>sleep<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MakeItemsAsync:</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,num_items,delta,sleep):</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_items <span class="op">=</span> num_items</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.delta <span class="op">=</span> delta</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sleep <span class="op">=</span> sleep</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,x):</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> asyncio.sleep(<span class="va">self</span>.sleep)</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [x<span class="op">+</span>i<span class="op">*</span><span class="va">self</span>.delta <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_items)]</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'MakeItemsAsync(num_items=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>num_items<span class="sc">}</span><span class="ss">,delta=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>delta<span class="sc">}</span><span class="ss">,sleep=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>sleep<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_all(<span class="op">*</span>arr):</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(arr)</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_to_arr(arr,x):</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [a<span class="op">+</span>x <span class="cf">for</span> a <span class="kw">in</span> arr]</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plus(x,y):</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span>y</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sort(arr):</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(arr)</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> asort(arr):</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(arr)</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> concat(arr1,arr2):</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arr1<span class="op">+</span>arr2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="basic-batch-processing" class="level2">
<h2 class="anchored" data-anchor-id="basic-batch-processing">Basic Batch Processing</h2>
<p>The simplest form of batch processing uses the for_each parameter to iterate over lists of items:</p>
<div id="cell-105" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'basic_batch'</span>, <span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'make_items'</span>, MakeItems(<span class="dv">3</span>, delta<span class="op">=</span><span class="dv">1</span>, sleep<span class="op">=</span><span class="fl">0.1</span>), inputs<span class="op">=</span>[<span class="st">'Start'</span>])</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'more_items'</span>, MakeItems(<span class="dv">3</span>, delta<span class="op">=</span><span class="dv">10</span>, sleep<span class="op">=</span><span class="fl">0.1</span>),</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>        for_each<span class="op">=</span>[<span class="st">'x'</span>],  <span class="co"># Iterate over each item in the input</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[<span class="st">'make_items(x)'</span>],</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[<span class="st">'End'</span>],</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        flat<span class="op">=</span><span class="va">True</span>  <span class="co"># Flatten the resulting nested lists</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>, sort)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-51-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In this example: * make_items generates a list [0, 1, 2] * more_items processes each number separately, generating [10, 11, 12] for each input * The flat=True parameter combines all results into a single list * Finally, the results are sorted</p>
<p>When run with input 0, produces: [0, 1, 2, 10, 11, 12, 20, 21, 22]</p>
<div id="cell-107" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run(<span class="dv">0</span>):</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node Start:
{'input': {0: 0}, 'output': 0}
================================================================================
Node make_items:
{'input': {0: 0}, 'output': [0, 1, 2]}
================================================================================
Node more_items[0]:
{'input': {'x': 0}, 'output': [0, 10, 20]}
================================================================================
Node more_items[1]:
{'input': {'x': 1}, 'output': [1, 11, 21]}
================================================================================
Node more_items[2]:
{'input': {'x': 2}, 'output': [2, 12, 22]}
================================================================================
Node End:
{ 'input': {0: [0, 10, 20, 1, 11, 21, 2, 12, 22]},
  'output': [0, 1, 2, 10, 11, 12, 20, 21, 22]}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="cartesian-products" class="level2">
<h2 class="anchored" data-anchor-id="cartesian-products">Cartesian Products</h2>
<p>You can process multiple input streams in parallel using for_each with multiple parameters:</p>
<div id="cell-109" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'batch_processing_sleep_product'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'one'</span>,MakeItemsAsync(<span class="dv">2</span>,<span class="dv">1</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start(0=1)'</span>])</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'two'</span>,MakeItemsAsync(<span class="dv">2</span>,<span class="dv">100</span>,sleep<span class="op">=</span><span class="fl">0.10</span>),inputs<span class="op">=</span>[<span class="st">'Start(0=2)'</span>])</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'three'</span>,MakeItemsAsync(<span class="dv">2</span>,<span class="dv">10000</span>,sleep<span class="op">=</span><span class="fl">0.2</span>),inputs<span class="op">=</span>[<span class="st">'Start(0=3)'</span>])</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'sum'</span>,sum_all,inputs<span class="op">=</span>[<span class="st">'one(0)'</span>,<span class="st">'two(1)'</span>,<span class="st">'three(2)'</span>],for_each<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'sum'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-53-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-110" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>sum_all(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>6</code></pre>
</div>
</div>
<div id="cell-111" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="dv">1</span>:<span class="dv">10</span>,<span class="dv">2</span>:<span class="dv">1000</span>,<span class="dv">3</span>:<span class="dv">100000</span>}):</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># trace.pprint()</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="dv">101010</span>, <span class="dv">101011</span>, <span class="dv">101110</span>, <span class="dv">101111</span>, <span class="dv">111010</span>, <span class="dv">111011</span>, <span class="dv">111110</span>, <span class="dv">111111</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="mixing-stream-and-non-stream-inputs" class="level2">
<h2 class="anchored" data-anchor-id="mixing-stream-and-non-stream-inputs">Mixing Stream and Non-Stream Inputs</h2>
<p>You can combine batch processing with regular inputs:</p>
<div id="cell-113" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> - try to do sub diagram with flat and without flat to see what's happening</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-114" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'batch_processing_comb_bad'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D_bad:</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'non_stream_first'</span>,add_to_arr,inputs<span class="op">=</span>[<span class="st">'Start(arr)'</span>,<span class="st">'State/x(x = .)'</span>])</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'stream_first'</span>,MakeItemsAsync(<span class="dv">3</span>,<span class="dv">10</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start(x)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>],flat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Concat'</span>,concat,inputs<span class="op">=</span>[<span class="st">'non_stream_first(0)'</span>,<span class="st">'stream_first(1)'</span>])</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,inputs<span class="op">=</span>[<span class="st">'Concat'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-57-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-115" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>dd <span class="op">=</span> D_bad()</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> dd.run([<span class="dv">0</span>],state<span class="op">=</span>{<span class="st">'x'</span>:<span class="dv">100</span>,<span class="st">'y'</span>:<span class="dv">1000</span>}):</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node non_stream_first:
{'input': {'arr': [0], 'x': 100}, 'output': [100]}
================================================================================
Node stream_first[0]:
{'input': {'x': 0}, 'output': [0, 10, 20]}
================================================================================
Node Concat:
{'input': {0: [100], 1: [0, 10, 20]}, 'output': [100, 0, 10, 20]}
================================================================================</code></pre>
</div>
</div>
<div id="cell-116" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'batch_processing_comb'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'non_stream_first'</span>,add_to_arr,inputs<span class="op">=</span>[<span class="st">'Start(arr)'</span>,<span class="st">'State/x(x = .)'</span>])</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'stream_first'</span>,MakeItemsAsync(<span class="dv">3</span>,<span class="dv">10</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start(x)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>],flat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'non_stream_second'</span>,add_to_arr,inputs<span class="op">=</span>[<span class="st">'non_stream_first(_)'</span>,<span class="st">'stream_first(arr)'</span>,<span class="st">'State/y(x = .)'</span>])</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'stream_second'</span>,add_to_arr,inputs<span class="op">=</span>[<span class="st">'stream_first(x)'</span>,<span class="st">'non_stream_first(arr)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>],flat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'Concat'</span>,concat,inputs<span class="op">=</span>[<span class="st">'non_stream_second(0)'</span>,<span class="st">'stream_second(1)'</span>])</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'Concat'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-59-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-117" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with checkLogs(name='stringdale.diagrams.flow'):</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run([<span class="dv">0</span>],state<span class="op">=</span>{<span class="st">'x'</span>:<span class="dv">100</span>,<span class="st">'y'</span>:<span class="dv">1000</span>}):</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node non_stream_first:
{'input': {'arr': [0], 'x': 100}, 'output': [100]}
================================================================================
Node stream_first[0]:
{'input': {'x': 0}, 'output': [0, 10, 20]}
================================================================================
Node non_stream_second:
{'input': {'arr': [0, 10, 20], 'x': 1000}, 'output': [1000, 1010, 1020]}
================================================================================
Node stream_second[2]:
{'input': {'arr': [100], 'x': 20}, 'output': [120]}
================================================================================
Node stream_second[0]:
{'input': {'arr': [100], 'x': 0}, 'output': [100]}
================================================================================
Node stream_second[1]:
{'input': {'arr': [100], 'x': 10}, 'output': [110]}
================================================================================
Node Concat:
{ 'input': {0: [1000, 1010, 1020], 1: [120, 100, 110]},
  'output': [1000, 1010, 1020, 120, 100, 110]}
================================================================================
Node End:
{ 'input': {0: [1000, 1010, 1020, 120, 100, 110]},
  'output': [100, 110, 120, 1000, 1010, 1020]}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="nested-diagrams-in-batch-processing" class="level2">
<h2 class="anchored" data-anchor-id="nested-diagrams-in-batch-processing">Nested Diagrams in Batch Processing</h2>
<p>You can even use entire diagrams as batch processors:</p>
<div id="cell-119" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> add_sleep(x):</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> asyncio.sleep(<span class="fl">0.1</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x<span class="op">+</span><span class="dv">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-120" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'async_adder'</span>)<span class="im">as</span> AsyncAdd:</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,add_sleep,inputs<span class="op">=</span>[<span class="st">'Start(x=x)'</span>],outputs<span class="op">=</span>[<span class="st">'End'</span>])</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>async_add<span class="op">=</span>AsyncAdd()</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> async_add.run({<span class="st">'x'</span>:<span class="dv">0</span>}):</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-62-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-121" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'nested_foreach'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'generate'</span>,MakeItemsAsync(<span class="dv">3</span>,<span class="dv">10</span>,sleep<span class="op">=</span><span class="fl">0.05</span>),inputs<span class="op">=</span>[<span class="st">'Start(**)'</span>])</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'add'</span>,AsyncAdd,inputs<span class="op">=</span>[<span class="st">'generate(x=.)'</span>],for_each<span class="op">=</span>[<span class="st">'x'</span>])</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'add'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-63-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-122" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span>D()</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run({<span class="st">'x'</span>:<span class="dv">0</span>}):</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    trace.pprint(skip_passthrough<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Node generate:
{'input': {'x': 0}, 'output': [0, 10, 20]}
================================================================================
Node add[1].add:
{'input': {'x': 10}, 'output': 11}
================================================================================
Node add[0].add:
{'input': {'x': 0}, 'output': 1}
================================================================================
Node add[2].add:
{'input': {'x': 20}, 'output': 21}
================================================================================
Node add[1]:
{'input': {'x': 10}, 'output': 11}
================================================================================
Node add[2]:
{'input': {'x': 20}, 'output': 21}
================================================================================
Node add[0]:
{'input': {'x': 0}, 'output': 1}
================================================================================
Node End:
{'input': {0: [11, 21, 1]}, 'output': [1, 11, 21]}
================================================================================</code></pre>
</div>
</div>
</section>
<section id="real-world-example-text-processing" class="level2">
<h2 class="anchored" data-anchor-id="real-world-example-text-processing">Real-World Example: Text Processing</h2>
<p>Here’s a practical example of batch processing for text analysis:</p>
<div id="cell-124" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>sample_doc <span class="op">=</span> {<span class="st">'text'</span>:<span class="st">"""</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="st">The elephant is one of the most remarkable creatures on Earth. Known for their intelligence and complex social structures, elephants form deep family bonds that can last a lifetime. These gentle giants possess remarkable memory capabilities and demonstrate emotional behaviors like mourning their dead. Their distinctive trunks, containing over 40,000 muscles, serve multiple purposes from gathering food to expressing affection.</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="st">The arctic fox is a fascinating animal that has adapted perfectly to life in the extreme cold. During winter, its thick white fur provides both insulation and camouflage in the snowy landscape, while in summer its coat turns brownish-gray to blend with the tundra. These resourceful predators can survive temperatures as low as -50°C (-58°F) and will travel vast distances across the Arctic ice in search of food, often following polar bears to scavenge their leftovers.</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="st">The octopus stands out as one of the ocean's most intelligent invertebrates. With nine brains (one central brain and eight additional ones in each arm), these cephalopods can solve complex puzzles, open jars, and even use tools. Their remarkable ability to change both color and texture allows them to perfectly mimic their surroundings, making them masters of disguise. Despite their impressive capabilities, most octopus species live only 1-2 years, making their intelligence even more remarkable given their short lifespan.</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="st">'id'</span>:<span class="st">'animal_book'</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> splitter(doc):</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    doc_id <span class="op">=</span> doc[<span class="st">'id'</span>]</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> doc[<span class="st">'text'</span>]</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{<span class="st">'text'</span>:chunk.strip(),<span class="st">'id'</span>:<span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>} <span class="cf">for</span> i,chunk <span class="kw">in</span> <span class="bu">enumerate</span>(text.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>))]</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarizer(text):</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> text[:<span class="dv">20</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-125" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Define(<span class="st">'Distilation Rag Uploader'</span>,<span class="bu">type</span><span class="op">=</span><span class="st">'flow'</span>) <span class="im">as</span> D:</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'split_texts'</span>,splitter,inputs<span class="op">=</span>[<span class="st">'Start(doc=.)'</span>],for_each<span class="op">=</span>[<span class="st">'doc'</span>],flat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'summarize_texts'</span>,summarizer,inputs<span class="op">=</span>[<span class="st">'split_texts(text=text)'</span>],for_each<span class="op">=</span>[<span class="st">'text'</span>])</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    V(<span class="st">'End'</span>,sort,inputs<span class="op">=</span>[<span class="st">'summarize_texts'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="090_old_tutorial_files/figure-html/cell-66-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This pipeline: * Takes a document and splits it into chunks * Processes each chunk independently * Combines and sorts the results</p>
<div id="cell-127" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> D()</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> trace <span class="kw">in</span> d.run([sample_doc]):</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#trace.pprint()</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> d.output <span class="op">==</span> [<span class="st">'The arctic fox is a '</span>, <span class="st">'The elephant is one '</span>, <span class="st">'The octopus stands o'</span>],d.output</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="stateful-nodes-and-serialization" class="level1">
<h1>Stateful nodes and Serialization</h1>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/DeanLight\.github\.io\/StringDALE");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/DeanLight/StringDALE/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>